{% extends "core.html" %}
{% load core %} 

{% block headertitle %}
  <div id="info" style="display: none;"></div>
{% endblock %}

{% block headernav %}
    <ul class="tab_headers">
    {% for tab, fieldsets in tabs %}
        {% ifnotequal tab "Zentrum" %}
        <li><a href="#tabs-{{ forloop.counter }}">{{ tab }}</a></li>
        {% endifnotequal %}
    {% endfor %}
    </ul>
    {{ block.super }}
{% endblock %}

{% block header_actions %}
    {{ block.super }}
    <div class="header_actions">
      <a href="" id="save-button" class="button_save">Speichern</a>
      <a href="" id="validate-button" class="button_validate">Validieren</a>
      <a href="" id="submit-button" class="button_submit">Einreichen</a>
    </div>
{% endblock %}

{% block content %}
    <form action="" method="post" enctype="multipart/form-data" class="tabbed main">
        <div id="tabs">
            {% for tab, fieldsets in tabs %}
                {% ifnotequal tab "Zentrum" %}
                <div id="tabs-{{ forloop.counter }}" class="tab">
                    {% ifequal tab "Massnahmen" %}
                        {# FIXME #}
                        <div class="field">
                            <h3>Studienbezogen durchzuführende Therapie und Diagnostik</h3>
                            {% with measure_formset as formset %}
                                {% include "forms/tables/inline_formset.html" %}
                            {% endwith %}
                        </div>
                        <div class="field">
                            <h3>Routinemäßig durchzuführende Therapie und Diagnostik</h3>
                            {% with routinemeasure_formset as formset %}
                                {% include "forms/tables/inline_formset.html" %}
                            {% endwith %}
                        </div>
                        <div class="field">
                            <h3>Sonstige im Rahmen der Studie verabreichte Medikamente, deren Wirksamkeit und/oder Sicherheit nicht Gegenstand der Prüfung sind</h3>
                            {% with nontesteduseddrug_formset as formset %}
                                {% include "forms/tables/inline_formset.html" %}
                            {% endwith %}
                        </div>
                    {% endifequal %}
                                        
                    {% ifequal tab "Unterlagen" %}
                        {# FIXME #}
                        <div class="field">
                            {% include "documents/upload_form.html" %}
                        </div>
                    {% endifequal %}
                    
                    {% for legend, fields in fieldsets %}
                        <div class="field fieldset_{{ forloop.counter }}">
                            {% if legend %}
                                <h3>{{ legend }}</h3>
                            {% endif %}
                            {% ifequal legend "Zentren im Ausland" %}
                                {# FIXME #}
                                {% with foreignparticipatingcenter_formset as formset %}
                                    {% include "forms/tables/inline_formset.html" %}
                                {% endwith %}                            
                            {% endifequal %}                            
                            <ol>
                                {% for field_name in fields %}
                                    {% with form|getitem:field_name as field %}
                                        {% include "forms/field.html" %}
                                    {% endwith %}
                                {% endfor %}
                            </ol>
                        </div>
                    {% endfor %}
                </div>
                {% endifnotequal %}
            {% endfor %}
        </div>

        {{ investigator_formset.management_form }}
        {{ investigatoremployee_formset.management_form }}
        
        <div id="investigator_formset">
        {% for form in investigator_formset.forms %}
            {% with forloop.counter0 as investigator_index %}
            <div class="investigator_tab tab" id="investigator_tab{{ forloop.counter0 }}">
                <div class="field">
                    <h3 class="partbno">Zentrum</h3>
                    <div class="investigator_form">
                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                        <ol>
                            {% for field in form %}
                                {% if not field.is_hidden %}
                                    {% include "forms/field.html" %}
                                {% endif %}
                            {% endfor %}
                        </ol>
                    </div>
                </div>
                <div class="field">
                    <h3>Verantwortliche Mitarbeiter/innen an der klinischen Studie (an Ihrer Prüfstelle)</h3>
                    {# FIXME: reuse forms/tables/inline_formset.html #}
                    <table class="inline_formset investigatoremployee_formset">
                        <thead>
                        <tr>
                            <th></th>
                            {% for field in investigatoremployee_formset|empty_form %}
                                {% if not field.is_hidden and not field.html_name|endswith:'-DELETE' %}
                                    {% with field|get_field_info as field_info %}
                                    <th class="label">
                                        {{ field_info.label|default:field.label }}
                                        {% if field_info.number %}
                                            <span class="paperform_number">{{ field_info.number }}</span>
                                        {% endif %}
                                        {% if field_info.help_text %}
                                        <span class="help_text">
                                            {{ field_info.help_text }}
                                        </span>
                                        {% endif %}
                                    </th>
                                    {% endwith %}
                                {% endif %}
                            {% endfor %}
                        </tr>
                        </thead>
                        <tbody>
                        {% for form in investigatoremployee_formset.forms %}
                            {% ifequal form.investigator_index.data|default:"0" investigator_index|stringformat:'s' %}
                            <tr class="form">
                                {% include "forms/tables/row.html" %}
                            </tr>
                            {% endifequal %}
                        {% empty %}
                            {% with investigatoremployee_formset|empty_form as form %}
                                <tr class="form template">
                                    {% include "forms/tables/row.html" %}
                                </tr>
                            {% endwith %}
                        {% endfor%}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endwith %}
        {% endfor%}
        </div>
        <input type="submit" name="validate" value="validate" class="hidden" />
        <input type="submit" name="submit" value="submit" class="hidden" />
    </form>
{% endblock %}

{% block menuSelection %}0{% endblock %}
{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript" src="{{ MEDIA_URL }}js/forms.js"></script>
    <script type="text/javascript"> 
        window.addEvent('domready', function(){
            var formsets = [
                '{{ measure_formset.prefix }}', 
                '{{ routinemeasure_formset.prefix }}', 
                '{{ nontesteduseddrug_formset.prefix }}', 
                '{{ foreignparticipatingcenter_formset.prefix }}', 
            ].map(function(prefix){
                return new ecs.InlineFormSet($(prefix + '_formset'), {
                    prefix: prefix
                });
            });
            
            $('save-button').addEvent('click', function(){
                ecs.mainForm.autosave(true);
                return false;
            });
            $('validate-button').addEvent('click', function(){
                ecs.mainForm.submit('validate');
                return false;
            });
            $('submit-button').addEvent('click', function(){
                ecs.mainForm.submit('submit');
                return false;
            });
            
            [
                'id_project_type_misc', 
                'id_pharma_checked_substance', 
                'id_pharma_reference_substance', 
                'id_substance_p_c_t_period',
                'id_medtech_checked_product',
                'id_medtech_reference_substance',
                'id_medtech_technical_safety_regulations',
                'id_medtech_departure_from_regulations',
                'id_additional_therapy_info',
                
            ].each(function(id){
                ecs.setupRichTextEditor($(id));
            });
        });
    </script>
{% endblock %}
