<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}pdfviewer/css/pdfviewer.css" />
  <title>ECS PDF Viewer</title>
</head>

<body>

<div class="pv">

  <div class="pv_main" style="">
    <div class="pv_header" style="">
      <div id="pv_title" class="pv_title"></div>
    </div>
    <div class="pv_pages">
      <div id="pv_page" class="pv_page"></div>
      <div id="pv_cursor" class="pv_cursor"></div>
    </div>
  </div>

</div>

<script type="text/javascript" src="{{ MEDIA_URL }}js/mootools-1.2.4-core.js"></script>

<script type="text/javascript">
  window.addEvent('domready', function(){

    var PdfViewer = new Class({

      initialize: function() {
        this.id = '{{ id }}';
        this.page = {{ page }};
        this.pages = {{ pages }};
        this.zoom_index = {{ zoom_index }};
        this.zoom_list = {% autoescape off %}{{ zoom_list }}{% endautoescape %};
        this.zoom_pages = {% autoescape off %}{{ zoom_pages }}{% endautoescape %};
        this.width = {{ width }};
        this.height = {{ height }};
        this.images = {% autoescape off %}{{ images }}{% endautoescape %};
        this.zooms = this.zoom_list.length;
        this.zoom_delta = 1;
        this.subpages = 0;
        this.subpages_x = 0;
        this.subpages_y = 0;
        this.bigpages = 0;
        this.bigpage = 0;
        this.subpage = 0;
        this.subpage_x = 0;
        this.subpage_y = 0;
        this.subpage_width = 0;
        this.subpage_height = 0;
        this.prev_boundary = 0;
        this.next_boundary = 0;
        this.calculate();
        this.set_image();
      },

      calculate: function() {
        this.zoom = this.zoom_list[this.zoom_index];
        this.subpages_x = this.zoom_pages[this.zoom_index][0];
        this.subpages_y = this.zoom_pages[this.zoom_index][1];
        this.subpages = this.subpages_x * this.subpages_y;
        this.bigpages = parseInt((this.pages - 1) / this.subpages) + 1;
        this.bigpage = parseInt((this.page - 1) / this.subpages) + 1;
        this.subpage = this.page - (this.bigpage - 1) * this.subpages;
        this.subpage_y = parseInt((this.subpage - 1) / this.subpages_x);
        this.subpage_x = this.subpage - this.subpage_y * this.subpages_x - 1;
        this.subpage_width = parseInt(this.width / this.subpages_x);
        this.subpage_height = parseInt(this.height / this.subpages_y);
        this.prev_boundary = this.subpages;
        this.next_boundary = this.pages - this.subpages + 1;
      },

      update_title: function() {
        var title = $('pv_title');
        var info = 'ID ' + this.id + ', Seite ' + this.page + ' von ' + this.pages;
        if (this.zoom != '1') {
          info += ' (Übersichtsseite ' + this.bigpage + ', Unterseite ' + this.subpage + ')';
        }
        info += ', Zoom ' + this.zoom;
        var status = ' lädt ..';
        if (!title.hasChild('pv_title_info')) {
          title.grab(new Element('span', { id: 'pv_title_info', html: info }));
          title.grab(new Element('span', { id: 'pv_title_status', html: status }));
        } else {
          $('pv_title_info').setProperties({ html: info });
          $('pv_title_status').setProperties({ html: status });
        }
      },

      set_cursor: function() {
        if (this.zoom == '1') {
          $('pv_cursor').setStyle('visibility', 'hidden');
        } else {
          $('pv_cursor').setStyles({
            top: 28 + this.subpage_y * this.subpage_height,
            left: 9 + this.subpage_x * this.subpage_width,
            width: this.subpage_width,
            height: this.subpage_height,
            visibility: 'visible'
          });
        }
      },

      image_loaded: function() {
        $('pv_title_status').setProperties({ html: '' });
      },

      set_image: function() {
        var pv_page = $('pv_page');
        var z = this.images[this.zoom];
        if (!$defined(z)) {
          alert('error: no image data for zoom: [' + this.zoom + ']');
          return;
        }
        var p = z[this.bigpage];
        if (!$defined(p)) {
          alert('error: no image data for zoom: [' + this.zoom + '], bigpage: [' + this.bigpage + ']');
          return;
        }
        var src = p['url'];
        var alt = 'Seite ' + this.bigpage + ' von ' + this.bigpages;
        if (!pv_page.hasChild('pv_img')) {
          pv_page.grab(new Element('img', { id: 'pv_img', src: src, width: this.width, height: this.height, alt: alt }));
        } else {
          $('pv_img').setProperties({ src: src, alt: alt });
        }
        this.update_title();
        this.set_cursor();
      },

      set_prev: function() {
        if (this.page <= this.prev_boundary) {
          return;
        }
        this.page -= this.subpages;
        this.bigpage -= 1;
        this.set_image();
      },

      set_next: function() {
        if (this.page >= this.next_boundary) {
          this.set_last();
          return;
        }
        this.page += this.subpages;
        this.bigpage += 1;
        this.set_image();
      },

      set_first: function() {
        if (this.page == 1) {
          return;
        }
        this.page = 1;
        this.bigpage = 1;
        this.subpage = 1;
        this.set_image();
      },

      set_last: function() {
        if (this.page == this.pages) {
          return;
        }
        this.page = this.pages;
        this.bigpage = this.bigpages;
        this.subpage = this.pages - (this.bigpages - 1) * this.subpages;
        this.set_image();
      },

      set_zoom: function(zoom_index) {
        if (zoom_index < 0 || zoom_index >= this.zooms) {
          return;
        }
        this.zoom_index = zoom_index;
        this.calculate();
        this.set_image();
      },

      cycle_zoom: function() {
        if (this.zooms == 1) {
          return;
        }
        var new_zoom_index = this.zoom_index + this.zoom_delta;
        if (new_zoom_index >= this.zooms) {
          this.zoom_delta = -1;
          new_zoom_index = this.zooms - 2;
        } else if (new_zoom_index < 0) {
          this.zoom_delta = 1;
          new_zoom_index = 1;
        }
        this.set_zoom(new_zoom_index); 
      }
    });


    var pdf_viewer = new PdfViewer();


    $('pv_img').addEvent('load', function(event) {
      pdf_viewer.image_loaded();
    });

    $('pv_page').addEvent('click', function(event) {
      event.stop();
      if (pdf_viewer.zoom == '1') {
        var x = event.client.x;
        var mid_x = pdf_viewer.width / 2 + 12;
        if (x < mid_x) {
          pdf_viewer.set_prev();
        } else {
          pdf_viewer.set_next();
        }
        return;
      }
    });

    $(document).addEvent('keydown', function(event) {
      var code = event.code;
      var key = event.key;
      if (code == 33 || key == 'left') {
        event.stop();
        pdf_viewer.set_prev();
        return;
      }
      if (code == 34 || key == 'right') {
        event.stop();
        pdf_viewer.set_next();
        return;
      }
      if (code == 36) {
        event.stop();
        pdf_viewer.set_first();
        return;
      }
      if (code == 35) {
        event.stop();
        pdf_viewer.set_last();
        return;
      }
      if (key == 'esc' || key == 'q') {
        event.stop();
        //alert('exit somehow..');
        return;
      }
      if (key == 'enter') {
        event.stop();
        pdf_viewer.cycle_zoom();
        return;
      }
      if (key == '?' || code == 219) {
        event.stop();
        alert('PDF Viewer Hilfe\n\n' +
              'Eine Seite vor oder zurück blättern:\n' +
              '* [Bild hoch] und [Bild runter] Tasten\n' +
              '* Pfeiltasten [Links] und [Rechts]\n' +
              '* Einzelansicht (Zoomstufe \'1\'): auf linke oder rechte Hälfte einer Seite klicken\n' +
              'Erste Seite mit [Pos1] Taste\n' +
              'Letzte Seite mit [Ende] Taste\n' +
              '[Mausrad], um Zoomstufe zu ändern\n' +
              'Maus [Rechtsklick] oder [Enter], um Zoomstufe zu ändern (auf-/absteigend)\n');
        return;
      }
    });

    $(document.body).addEvent('mousewheel', function(event) {
      event.stop();
      var wheel = event.wheel;
      var new_zoom_index = pdf_viewer.zoom_index - parseInt(wheel);
      pdf_viewer.set_zoom(new_zoom_index);
    });

    $(document.body).addEvent('contextmenu', function(event) {
      event.stop();
      pdf_viewer.cycle_zoom();
    });

  });
</script>

</body>

</html>
