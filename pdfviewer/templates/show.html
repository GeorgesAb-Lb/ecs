<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}pdfviewer/css/pdfviewer.css" />
  <title>ECS PDF Viewer</title>
</head>

<body>

<div class="pv">

  <div class="pv_main" style="">
    <div class="pv_header" style="">
      <span id="pv_title" class="pv_title"></span>
    </div>
    <div class="pv_pages">
      <span id="pv_page" class="pv_page"></span>
    </div>
  </div>

</div>

<script type="text/javascript" src="{{ MEDIA_URL }}js/mootools-1.2.4-core.js"></script>

<script type="text/javascript">
  window.addEvent('domready', function(){

    var PdfViewer = new Class({

      initialize: function() {
        this.id = '{{ id }}';
        this.page = {{ page }};
        this.pages = {{ pages }};
        this.zoom = '{{ zoom }}';
        this.zoom_pages = {{ zoom_pages }};
        this.zoom_list = {% autoescape off %}{{ zoom_list }}{% endautoescape %};
        this.zooms = {{ zooms }};
        this.zoom_index = {{ zoom_index }};
        this.width = {{ width }};
        this.height = {{ height }};
        this.images = {% autoescape off %}{{ images }}{% endautoescape %};
        this.set_image();
        this.prev_boundary = this.zoom_pages;
        this.next_boundary = this.pages - this.zoom_pages + 1;
      },

      update_title: function() {
        var title = $('pv_title');
        var info = 'ID ' + this.id + ', Seite ' + this.page + ' von ' + this.pages + ', Zoom ' + this.zoom + ' (' + this.zoom_pages + ')';
        if (title.hasChild('pv_title_info')) {
          var title_info = $('pv_title_info');
          title_info.setProperties({ html: info });
        } else {
          var title_info = new Element('span', { id: 'pv_title_info', html: info });
          title.grab(title_info);
        }
      },

      set_image: function() {
        var pv_page = $('pv_page');
        var z = this.images[this.zoom];
        if (!$defined(z)) {
          alert('error: no data for zoom: [' + this.zoom + ']');
          return;
        }
        var p = z[this.page];
        if (!$defined(p)) {
          alert('error: no data for zoom: [' + this.zoom + '], page: [' + this.page + ']');
          return;
        }
        var src = p['url'];
        var alt = 'Seite ' + this.page + ' von ' + this.pages;
        {% comment %}Here we could add some cache of loaded images{% endcomment %}
        if (pv_page.hasChild('pv_img')) {
          var img = $('pv_img');
          img.setProperties({ src: src, alt: alt });
        } else {
          var img = new Element('img', { id: 'pv_img', src: src, width: this.width, height: this.height, alt: alt });
          pv_page.grab(img);
        }
        this.update_title();
      },

      set_prev: function() {
        if (this.page <= this.prev_boundary) {
          return;
        }
        this.page -= this.zoom_pages;
        this.set_image();
      },

      set_next: function() {
        if (this.page >= this.next_boundary) {
          this.set_last();
          return;
        }
        this.page += this.zoom_pages;
        this.set_image();
      },

      set_first: function() {
        if (this.page == 1) {
          return;
        }
        this.page = 1;
        this.set_image();
      },

      set_last: function() {
        if (this.page == this.pages) {
          return;
        }
        this.page = this.pages;
        this.set_image();
      },

      set_zoom: function(zoom_index) {
        if (zoom_index < 0 || zoom_index >= this.zooms) {
          return;
        }
        this.zoom = this.zoom_list[zoom_index];
        this.zoom_index = zoom_index;
        this.set_image();
      },

    });

    var pdf_viewer = new PdfViewer();

    $(document.body).getElements('.pv_page').addEvent('click', function(event) {
      event.stop();
      var x = event.client.x;
      var mid_x = pdf_viewer.width / 2 + 12;
      if (x < mid_x) {
        pdf_viewer.set_prev();
        return;
      } else {
        pdf_viewer.set_next();
        return;
      }
    });

    $(document).addEvent('keydown', function(event) {
      event.stop();
      var code = event.code;
      var key = event.key;
      if (code == 33 || key == 'left') {
        pdf_viewer.set_prev();
        return;
      }
      if (code == 34 || key == 'right') {
        pdf_viewer.set_next();
        return;
      }
      if (code == 36) {
        pdf_viewer.set_first();
        return;
      }
      if (code == 35) {
        pdf_viewer.set_last();
        return;
      }
      if (key == 'esc' || key== 'q') {
        alert('exit somehow..');
        return;
      }
    });

    $(document.body).addEvent('mousewheel', function(event) {
      event.stop();
      var wheel = event.wheel;
      var new_zoom_index = pdf_viewer.zoom_index - parseInt(wheel);
      pdf_viewer.set_zoom(new_zoom_index);
    });

  });
</script>

</body>

</html>
