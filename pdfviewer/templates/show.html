<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

{% load pdfviewer %}

{% url pdf_show id page|add:-1 zoom as pv_url_prev %}
{% url pdf_show id page|add:1 zoom as pv_url_next %}
{% url pdf_show id 1 zoom as pv_url_first %}
{% url pdf_show id pages zoom as pv_url_last %}

<head>
  <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}pdfviewer/css/pdfviewer.css" />
  <title>ECS PDF Viewer: ID {{ id }}, Seite {{ page }}, Zoom {{ zoom }}</title>
</head>

<body>

<div class="pv">

  <div class="pv_main" style="">
    <div class="pv_header" style="">
      <span class="pv_title">ID {{ id }}, Seite {{ page }} ({{ pages }} Seiten), Zoom {{ zoom }}</span>
    </div>
    <div class="pv_pages">
      <span class="pv_page"><img src="{{ image.url }}" style="height: {{ height }}px; width: {{ width }}px;" alt="Seite {{ image.page }} von {{ pages }}" /></span>
    </div>
  </div>

</div>

<script type="text/javascript" src="{{ MEDIA_URL }}js/mootools-1.2.4-core.js"></script>
<script type="text/javascript">
  var go_url = function(url) {
    window.location.href = url;
  };

  var go_url_prev = function() {
  {% if page|greater:1 %}
    go_url('{{ pv_url_prev }}');
  {% endif %}
  };

  var go_url_next = function() {
  {% if page|less:pages %}
    go_url('{{ pv_url_next }}');
  {% endif %}
  };

  var go_url_first = function() {
  {% if page|greater:1 %}
    go_url('{{ pv_url_first }}');
  {% endif %}
  };

  var go_url_last = function() {
  {% if page|less:pages %}
    go_url('{{ pv_url_last }}');
  {% endif %}
  };

  var go_url_zoom = function(zoom_index) {
    if (zoom_index < 0 || zoom_index >= {{ zooms }}) {
      return;
    }
    var zoom_list = [
    {% for zoom in zoom_list %}
      '{{ zoom }}'{% if not forloop.last %},{% endif %}
    {% endfor %}
    ];
    var zoom = zoom_list[zoom_index];
    go_url('/pdfviewer/{{ id }}/{{ page }}/' + zoom + '/');
  };

  window.addEvent('domready', function(){

    $(document.body).getElements('.pv_page').addEvent('click', function(event) {
      event.stop();
      var x = event.client.x;
      var mid_x = {{ width }} / 2 + 12;
      if (x < mid_x) {
        go_url_prev();
        return;
      } else {
        go_url_next();
        return;
      }
    });

    $(document.body).addEvent('mousewheel', function(event) {
      event.stop();
      var wheel = event.wheel;
      var new_zoom_index = {{ zoom_index }} - parseInt(wheel);
      go_url_zoom(new_zoom_index);
    });

    $(document.body).addEvent('contextmenu', function(event) {
      event.stop();
      var shift = event.shift;
      var delta = 1;
      if (shift) {
        delta = -delta;
      }
      var new_zoom_index = ({{ zoom_index }} + delta) % {{ zooms }};
      if (new_zoom_index < 0) {
        new_zoom_index += {{ zooms }};
      }
      go_url_zoom(new_zoom_index); 
    });

    $(document).addEvent('keydown', function(event) {
      event.stop();
      var code = event.code;
      var key = event.key;
      if (code == 33 || key == 'left') {
        go_url_prev();
        return;
      }
      if (code == 34 || key == 'right') {
        go_url_next();
        return;
      }
      if (code == 36) {
        go_url_first();
        return;
      }
      if (code == 35) {
        go_url_last();
        return;
      }
      if (key == 'esc' || key== 'q') {
        alert('exit somehow..');
        return;
      }
    });

  });
</script>

</body>

</html>
