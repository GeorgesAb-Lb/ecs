{% extends "core.html" %}
{% load i18n core userutils communication %}

{% block menuSelection %}communication{% endblock %}

{% block headertitle %}
    {{ thread|remote:user }} -
    {% if thread.submission %}
        {{ thread.submission|ec_number }} -
    {% endif %}
    {{ thread.subject }}
    ({{ thread.message_list|length }})
{% endblock %}

{% block content %}
<div class="communication_thread">

<a href="{% url ecs.communication.views.list_threads %}"><button>{% trans "Back to the communication overview" %}</button></a>
{% if thread.submission %}
<a href="{% url ecs.core.views.readonly_submission_form submission_form_pk=thread.submission.current_submission_form.pk %}#communication_tab"><button>{% trans "Back to the Study" %}</button></a>
{% endif %}

<ul class="thread">
{% for message in thread.message_list %}
    <li class="message">
        <div class="head">
            <span class="sender">{{ message.sender }}</span>
            <span class="preview"></span><span class="preview_text">{{ message|preview:80 }}</span>
            <span class="time">{{ message.timestamp|date:'d.m.Y H:i' }} Uhr</span>
        </div>
        <pre class="body">{{ message.text|safe }}<pre>
    </li>
{% endfor %}
</ul>
<div class="expand_collapse">
    <a href="" class="collapse_all">{% trans "Collapse all" %}</a>
    | <a href="" class="expand_all">{% trans "Expand all" %}</a>
</div>

{% if not thread|closed_by:user %}
    als erledigt markieren: <a class="icon_done" href="{% url ecs.communication.views.close_thread thread_pk=thread.pk %}?next={{ request.path|urlencode }}" title="Erledigt">done</a>
{% endif %}

<form class="send" method="post">
    <table>
        {{ form.as_table }}
    </table>
    <input type="submit" value="{% trans "Send" %}">
</form>

<a href="{% url ecs.communication.views.list_threads %}"><button>{% trans "Back to the communication overview" %}</button></a>
{% if thread.submission %}
<a href="{% url ecs.core.views.readonly_submission_form submission_form_pk=thread.submission.current_submission_form.pk %}#communication_tab"><button>{% trans "Back to the Study" %}</button></a>
{% endif %}

</div>
{% endblock %}

{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript">
      window.addEvent('domready', function(){
        var communication_thread = $$('.communication_thread')[0];
        var container = communication_thread.getElement('ul');
        var collapse_link = communication_thread.getElement('.collapse_all');
        var expand_link = communication_thread.getElement('.expand_all');
        var thread = new ecs.communication.Thread(container, collapse_link, expand_link);
        thread.scroll_to_last_message();

        var messageToolbarItems = [];

        {% if thread.submission %}
            messageToolbarItems.push(ecs.textarea.toolbarItems.annotations("{% trans 'Insert Annotations' %}", '{% url ecs.pdfviewer.views.copy_annotations %}?submission_form_pk={{ thread.submission.current_submission_form.pk }}'));
        {% endif %}

        {% if user|has_flag:'internal' %}
            messageToolbarItems.push(ecs.textarea.toolbarItems.boilerplate("{% trans 'Insert Boilerplate' %}", "{% url ecs.boilerplate.views.select_boilerplate %}"));
        {% endif %}

        var textarea = communication_thread.getElement('textarea[name="text"]');
        new ecs.textarea.TextArea(textarea);
        ecs.textarea.installToolbar(textarea, messageToolbarItems);
      });
    </script>
{% endblock %}

