{% extends "core.html" %}
{% load i18n core userutils communication %}

{% block menuSelection %}communication{% endblock %}

{% block headertitle %}
    {% if submission %}
        {{ thread.submission|ec_number }} -
    {% endif %}
    {% trans "New Message" %}
{% endblock %}

{% block content %}
<div class="message_display">
  <a href="{% url ecs.communication.views.list_threads %}">{% trans "Back to the communication overview" %}</a>
  {% if submission %}
      | <a href="{% url ecs.core.views.readonly_submission_form submission_form_pk=submission.current_submission_form.pk %}#communication_tab">{% trans "Back to the Study" %}</a>
  {% endif %}
  <form action="{{ request.path }}" method="post" class="form message open-in-widget">
      <ol>
          {% if submission %}
          <li>
              <label>Studie</label>
              <span>{{ submission|ec_number }} {{ submission.project_title_display|smart_truncate:50 }}</span>
          </li>
          {% endif %}

          {% if task %}
          <li>
              <label>Task</label>
              <span>{{ task }}</span>
          </li>
          {% endif %}

          {% if form.subject %}
          <li>
              <label for="{{ form.subject.auto_id }}">Betreff</label>
              {{ form.subject }}
              {% if form.subject.errors %}
                  <span class="errors">{{ form.subject.errors }}</span>
              {% endif %}
          </li>
          {% endif %}

          {% if form.instance.thread %}
            <li>
            <label for="id_participants">antworten an:</label><br>
            </li>
            {% for user in thread.get_participants %}
              <li>
              <input id="id_{{ user.pk }}" type="checkbox" name="{{ user.pk }}"/>
              {% if user.internal %}
                <label for="id_{{ user.pk }}">{{ user.first_name }} {{ user.last_name }}</label><br>
              {% else %}
                <label for="id_{{ user.pk }}">External: {{ user.first_name }} {{ user.last_name }} ({{ user.email }})</label><br>
              {% endif %}
              </li>
            {% endfor %}
          {% endif %}
          
          {% include 'communication/send_base.inc' %}

      </ol>
      <input type="submit" value="Abschicken" />
  </form>
  <a href="{% url ecs.communication.views.list_threads %}">{% trans "Back to the communication overview" %}</a>
  {% if submission %}
      | <a href="{% url ecs.core.views.readonly_submission_form submission_form_pk=submission.current_submission_form.pk %}#communication_tab">{% trans "Back to the Study" %}</a>
  {% endif %}
</div>
{% endblock %}

{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript">
      window.addEvent('domready', function(){
        var container = $$('.message_display')[0];
        ecs.setupMessagePopup(container);

        var messageToolbarItems = [];

        {% if submission %}
            messageToolbarItems.push(ecs.textarea.toolbarItems.annotations("{% trans 'Insert Annotations' %}", '{% url ecs.pdfviewer.views.copy_annotations %}?submission_form_pk={{ submission.current_submission_form.pk }}'));
        {% endif %}

        {% if user|has_flag:'internal' %}
            messageToolbarItems.push(ecs.textarea.toolbarItems.boilerplate("{% trans 'Insert Boilerplate' %}", "{% url ecs.boilerplate.views.select_boilerplate %}"));
        {% endif %}

        var textarea = container.getElement('textarea[name="text"]');
        new ecs.textarea.TextArea(textarea);
        ecs.textarea.installToolbar(textarea, messageToolbarItems);
      });
    </script>
{% endblock %}

