{% extends "core.html" %}
{% load humanize i18n core communication %}

{% block menuSelection %}communication{% endblock %}

{% block htmltitle %}{% trans "Communication" %} | {{ block.super }}{% endblock %}
{% block headertitle %}{% trans "Communication" %} ({% unread_msg_count %}){% endblock %}

{% block content %}

    <form id="thread_list_filter" action="{{ request.path }}" method="post" class="form-inline">
        {% csrf_token %}
        <ul class="list-unstyled">
            <li>
                {{ filterform.incoming }}
                <span class="fa fa-envelope-o"></span>
                {% trans "Incoming" %}
            </li>
            <li>
                {{ filterform.outgoing }}
                <span class="fa fa-paper-plane-o"></span>
                {% trans "Outgoing" %}
            </li>
        </ul>
        <ul class="list-unstyled">
            <li>
                {{ filterform.starred }}
                <span class="fa fa-star"></span>
                {% trans "Starred" %}
            </li>
            <li>
                {{ filterform.unstarred }}
                <span class="fa fa-star-o"></span>
                {% trans "Not Starred" %}
            </li>
        </ul>
        <ul class="list-unstyled">
            <li>
                <span class="fa fa-sort"></span>
                <a href="{{ request.path }}?sort={% if sort == 'submission' %}-{% endif %}submission">
                    {% trans 'Submission' %}
                </a>
            </li>
            <li>
                <span class="fa fa-sort"></span>
                <a href="{{ request.path }}?sort={% if sort == 'user' %}-{% endif %}user">
                    {% trans "Person" %}
                </a>
            </li>
            <li>
                <span class="fa fa-sort"></span>
                <a href="{{ request.path }}?sort={% if sort == 'timestamp' %}-{% endif %}timestamp">
                    {% trans "Old/New" %}
                </a>
            </li>
        </ul>
    </form>

    <table class="table table-sm">
        <colgroup>
            <col>
            <col>
            <col>
            <col class="w-100">
            <col>
            <col>
        </colgroup>
        <thead>
            <tr>
                <th></th>
                <th>{% trans "Von/An" %}</th>
                <th>{% trans "Submission" %}</th>
                <th>{% trans "Subject" %}</th>
                <th class="text-xs-right">{% trans "Date" %}</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for thread in page.object_list %}
                <tr {% if thread.last_message.unread and thread.last_message.receiver_id == user.id %}class="font-weight-bold"{% endif %}>
                    <td class="pr-1">
                        {% if thread|starred_by:user %}
                            {% url 'ecs.communication.views.unstar' thread_pk=thread.pk as unstar_url %}
                            <a class="open-in-widget fa fa-2x fa-star text-warning" href="{{ unstar_url }}?next={{ request.path|urlencode }}"></a>
                        {% else %}
                            {% url 'ecs.communication.views.star' thread_pk=thread.pk as star_url %}
                            <a class="open-in-widget fa fa-2x fa-star-o text-muted" href="{{ star_url }}?next={{ request.path|urlencode }}"></a>
                        {% endif %}
                    </td>
                    <td class="text-nowrap align-middle">
                        {% if thread.last_message.sender == user %}
                            <span class="fa fa-paper-plane-o"></span>
                            {% trans "an" %} {{ thread.last_message.receiver }}
                        {% else %}
                            <span class="fa fa-envelope-o"></span>
                            {% trans "von" %} {{ thread.last_message.sender }}
                        {% endif %}
                    </td>
                    <td class="text-nowrap align-middle">
                        {% if thread.submission %}
                            {{ thread.submission|ec_number }}
                        {% endif %}
                    </td>
                    <td class="align-middle">
                        {% url 'ecs.communication.views.read_thread' thread_pk=thread.pk as read_url%}
                        <a href="{{ read_url }}" title="{{ thread.last_message|preview:1000 }}">
                            {{ thread.subject|truncatewords:10 }}
                        </a>
                    </td>
                    <td class="text-nowrap align-middle text-xs-right">
                        {{ thread.last_message.timestamp|naturalday:'d.m.Y' }},
                        {{ thread.last_message.timestamp|date:'H:i'}}
                    </td>
                    <td class="pl-1 align-middle">
                    {% if thread.last_message.unread and thread.last_message.receiver_id == user.id %}
                        {% url 'ecs.communication.views.mark_read' thread_pk=thread.pk as mark_read_url %}
                        <a class="open-in-widget" href="{{ mark_read_url }}?next={{ request.path|urlencode }}">
                            <span class="fa fa-2x fa-check text-primary"></span>
                        </a>
                    {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td class="text-xs-center text-muted" colspan="6">
                        <em>{% trans 'No messages yet!' %}</em>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <nav class="text-xs-center paginator">
      <ul class="pagination">
        {% if page.has_previous %}
            <li class="page-item">
                <a class="page-link open-in-widget" href="{{ request.path }}?p=1&amp;sort={{ sort }}">
                    <span class="fa fa-fast-backward"></span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link open-in-widget" href="{{ request.path }}?p={{ page.previous_page_number }}&amp;sort={{ sort }}">
                    <span class="fa fa-backward"></span>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">
                    <span class="fa fa-fast-backward"></span>
                </span>
            </li>
            <li class="page-item disabled">
                <span class="page-link">
                    <span class="fa fa-backward"></span>
                </span>
            </li>
        {% endif %}
        <li class="page-item disabled">
            <span class="page-link">
                {% trans "Page" %} {{ page.number }} {% trans "of" %} {{ page.paginator.num_pages }}
            </span>
        </li>
        {% if page.has_next %}
            <li class="page-item">
                <a class="page-link open-in-widget" href="{{ request.path }}?p={{ page.next_page_number }}&amp;sort={{ sort }}">
                    <span class="fa fa-forward"></span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link open-in-widget" href="{{ request.path }}?p={{ page.paginator.num_pages }}&amp;sort={{ sort }}">
                    <span class="fa fa-fast-forward"></span>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">
                    <span class="fa fa-forward"></span>
                </span>
            </li>
            <li class="page-item disabled">
                <span class="page-link">
                    <span class="fa fa-fast-forward"></span>
                </span>
            </li>
        {% endif %}


      </ul>
    </nav>

    <div class="hint mt-1">
      <span class="fa fa-info text-info"></span>
      {% db_setting 'contact_email' as email %}
      {% blocktrans with contact_email=email %}
          To write a message, open the read-only view of a study and change to the communication tab.
          For general Questions write an email to <a href="mailto:{{ contact_email }}">{{ contact_email }}</a>.
      {% endblocktrans %}
    </div>
{% endblock %}

{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript">
        $(function(){
            $('#thread_list_filter input').change(function() {
                ecs.stopPageLoad();
                $('#thread_list_filter').submit();
            });
        });
    </script>
{% endblock %}

