{% extends "core.html" %}
{% load humanize i18n core communication %}

{% block menuSelection %}communication{% endblock %}

{% block htmltitle %}{% trans "Communication" %} | {{ block.super }}{% endblock %}
{% block headertitle %}{% trans "Communication" %} ({% unread_msg_count %}){% endblock %}

{% block content %}
    <div class="messages_header mb-1">
        <form id="thread_list_filter" action="" method="post">
            {% csrf_token %}
            <div class="thread_list_choose">
                <label>
                    {{ filterform.incoming }}
                    <span class="fa fa-envelope-o"></span>
                    {% trans "Incoming" %}
                </label>

                <label>
                    {{ filterform.outgoing }}
                    <span class="fa fa-paper-plane-o"></span>
                    {% trans "Outgoing" %}
                </label>
            </div>
            <div class="thread_list_choose">
                <label>
                    {{ filterform.starred }}
                    <span class="fa fa-star"></span>
                    {% trans "Starred" %}
                </label>

                <label>
                    {{ filterform.unstarred }}
                    <span class="fa fa-star-o"></span>
                    {% trans "Not Starred" %}
                </label>
            </div>
        </form>
        <div class="sort_options">
            <span class="fa fa-sort"></span>
            <a href="{{ request.path }}?sort={% if sort == 'submission' %}-{% endif %}submission">
                {% trans 'Submission' %}
            </a> |
            <a href="{{ request.path }}?sort={% if sort == 'user' %}-{% endif %}user">
                {% trans "Person" %}
            </a> |
            <a href="{{ request.path }}?sort={% if sort == 'timestamp' %}-{% endif %}timestamp">
                {% trans "Old/New" %}
            </a>
        </div>
    </div>

    <table class="table table-sm">
        <thead>
            <tr>
                <th></th>
                <th>{% trans "Von/An" %}</th>
                <th>{% trans "Submission" %}</th>
                <th>{% trans "Subject" %}</th>
                <th class="text-xs-right">{% trans "Date" %}</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for thread in page.object_list %}
                <tr {% if thread.last_message.unread and thread.last_message.receiver_id == user.id %}class="font-weight-bold"{% endif %}>
                    <td>
                        {% if thread|starred_by:user %}
                            {% url 'ecs.communication.views.unstar' thread_pk=thread.pk as unstar_url %}
                            <a class="open-in-widget fa fa-2x fa-star text-warning" href="{{ unstar_url }}?next={{ request.path|urlencode }}"></a>
                        {% else %}
                            {% url 'ecs.communication.views.star' thread_pk=thread.pk as star_url %}
                            <a class="open-in-widget fa fa-2x fa-star-o text-muted" href="{{ star_url }}?next={{ request.path|urlencode }}"></a>
                        {% endif %}
                    </td>
                    <td class="col-xs-4 col-lg-3 col-xl-2 align-middle">
                        {% if thread.last_message.sender == user %}
                            <span class="fa fa-paper-plane-o"></span>
                            {% trans "an" %} {{ thread.last_message.receiver }}
                        {% else %}
                            <span class="fa fa-envelope-o"></span>
                            {% trans "von" %} {{ thread.last_message.sender }}
                        {% endif %}
                    </td>
                    <td class="align-middle">
                        {% if thread.submission %}
                            {{ thread.submission|ec_number }}
                        {% endif %}
                    </td>
                    <td class="align-middle">
                        {% url 'ecs.communication.views.read_thread' thread_pk=thread.pk as read_url%}
                        <a href="{{ read_url }}" title="{{ thread.last_message|preview:1000 }}">
                            {{ thread.subject|truncatewords:10 }}
                        </a>
                    </td>
                    <td class="align-middle text-xs-right">
                        {{ thread.last_message.timestamp|naturalday:'d.m.Y' }},
                        {{ thread.last_message.timestamp|date:'H:i'}}
                    </td>
                    <td class="align-middle">
                    {% if thread.last_message.unread and thread.last_message.receiver_id == user.id %}
                        {% url 'ecs.communication.views.mark_read' thread_pk=thread.pk as mark_read_url %}
                        <a class="open-in-widget" href="{{ mark_read_url }}?next={{ request.path|urlencode }}">
                            <span class="fa fa-2x fa-check text-primary"></span>
                        </a>
                    {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="paginator text-xs-center">
        {% if page.has_previous %}
            <a class="open-in-widget fa fa-fast-backward" href="{{ request.path }}?p=1"></a>
            <a class="open-in-widget fa fa-backward" href="{{ request.path }}?p={{ page.previous_page_number }}&amp;sort={{ sort }}"></a>
        {% endif %}
        {% trans "Page" %} {{ page.number }} {% trans "of" %} {{ page.paginator.num_pages }}
        {% if page.has_next %}
            <a class="open-in-widget fa fa-forward" href="{{ request.path }}?p={{ page.next_page_number }}&amp;sort={{ sort }}"></a>
            <a class="open-in-widget fa fa-fast-forward" href="{{ request.path }}?p={{ page.paginator.num_pages }}&amp;sort={{ sort }}"></a>
        {% endif %}
    </div>
    <div class="hint mt-1">
      <span class="fa fa-info text-info"></span>
      {% db_setting 'contact_email' as email %}
      {% blocktrans with contact_email=email %}
          To write a message, open the read-only view of a study and change to the communication tab.
          For general Questions write an email to <a href="mailto:{{ contact_email }}">{{ contact_email }}</a>.
      {% endblocktrans %}
    </div>
{% endblock %}

{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript">
        $(function(){
            $('#thread_list_filter input').change(function() {
                ecs.stopPageLoad();
                $('#thread_list_filter').submit();
            });
        });
    </script>
{% endblock %}

