{% extends "shell.html" %}
{% load i18n pdfviewer compress userutils %}

{% block htmltitle %}
{% if document.parent_object %}{{ document.parent_object }}: {% endif %}{{ document.doctype_name }}
{% endblock %}

{% block htmlmeta %}
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0" />
    {% if not document|is_ready %}
        <meta http-equiv="refresh" content="10" />
    {% endif %}
{% endblock %}

{% block jsbottom %}
<!--<script type="text/javascript" src="https://getfirebug.com/firebug-lite.js"></script>-->
{% compress js %}
    <script type="text/javascript" src="{{ MEDIA_URL }}3rd-party/MooTools/mootools-core-1.4.1-full-nocompat-yc.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}3rd-party/MooTools/mootools-more-1.4.0.1.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}3rd-party/MooToolsCustomEvent/Source/Element.defineCustomEvent.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}3rd-party/MooToolsMobile/Source/Browser/Features.Touch.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}3rd-party/MooToolsMobile/Source/Desktop/Mouse.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}3rd-party/MooToolsMobile/Source/Touch/Click.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}3rd-party/MooToolsMobile/Source/Touch/Touch.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}3rd-party/MooToolsMobile/Source/Touch/Swipe.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}3rd-party/MooToolsMobile/Source/Touch/Touchhold.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}3rd-party/MooToolsMobile/Source/Touch/Pinch.js"></script>
    
    <script type="text/javascript" src="{{ MEDIA_URL }}js/ecs/autocomplete.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/ecs/dragdrop.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/ecs/widgets.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/ecs/utils.js"></script>
    
    <script type="text/javascript" src="{{ MEDIA_URL }}js/ecs/pdfviewer/__init__.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/ecs/pdfviewer/ImageSet.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/ecs/pdfviewer/Annotation.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/ecs/pdfviewer/DocumentViewer.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/ecs/pdfviewer/Popup.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}camera/camera.js"></script>
{% endcompress %}

<script type="text/javascript">
    $(window).addEvent('domready', function(){
        {% if document|is_ready %}
            var viewer = new ecs.pdfviewer.DocumentViewer($('pdfviewer'), {
                pageCount: {{ document.pages }},
                title: '{{ title|truncatechars:80|escapejs }}'
                    + '<div class="details">{% trans "Date" %}: {{ document.date|date:"d.m.Y" }}<br>{% trans "Version" %}: {{ document.version|truncatechars:30|escapejs }}</div>',
                controllers: [
                    new ecs.pdfviewer.Controller('5x5', 5, 5),
                    new ecs.pdfviewer.Controller('1x1', 1, 1)
                ],
                metaKey: '{{ user.ecs_settings.pdfviewer_settings.metaKey }}',
                searchURL: '{% url ecs.documents.views.document_search_json document_pk=document.pk %}',
                editAnnotationURL: '{% url ecs.pdfviewer.views.edit_annotation document_pk=document.pk %}',
                deleteAnnotationURL: '{% url ecs.pdfviewer.views.delete_annotation document_pk=document.pk %}',
                allowAnnotationSharing: {{ user|has_flag:'is_internal'|yesno:'true,false' }},
                helpURL: '{% url ecs.help.views.find_help view_pk=request.tracking_data.view.pk %}',

                wheelScrollThreshold: 1,
                wheelTimeThreshold: 200, // ms
                swipeDistance: 30, // px
                touchholdDelay: 300, // ms
                pinchThreshold: 0.4,
                touchCenterSize: 100, // px

                shortcuts: [
                    /* in case of conflict, the first shortcut wins */
                    {command: 'showHelp',             key: 'space',  annotationMode: true},
                    {command: 'toggleAnnotationMode', key: 'a', meta: true,  annotationMode: true},
                    {command: 'quitAnnotationMode',   key: 'esc', annotationMode: true},

                    {command: 'previousPage',       key: 'pageup', top: true},
                    {command: 'scrollToTop',        key: 'pageup'},
                    {command: 'previousPage',       key: '1', top: true},
                    {command: 'scrollToTop',        key: '1'},

                    {command: 'nextPage',           key: 'pagedown', bottom: true},
                    {command: 'scrollToBottom',     key: 'pagedown'},
                    {command: 'nextPage',           key: '9', bottom: true},
                    {command: 'scrollToBottom',     key: '9'},

                    {command: 'selectPreviousPage', key: 'left'},
                    {command: 'firstPage',          key: 'left', shift: true, meta:true},
                    {command: 'previousPage',       key: 'left', meta: true},
                    
                    {command: 'selectNextPage',     key: 'right'},
                    {command: 'nextPage',           key: 'right', meta: true},
                    {command: 'lastPage',           key: 'right', shift:true, meta: true},

                    {command: 'selectNextRow',      key: 'down'},
                    {command: 'lastPage',           key: 'down', shift: true, meta: true},
                    {command: 'nextPage',           key: 'down', meta: true},

                    {command: 'selectPreviousRow',  key: 'up'},
                    {command: 'firstPage',          key: 'up', shift: true, meta: true},
                    {command: 'previousPage',       key: 'up', meta: true},
                    
                    {command: 'cycleIn',            key: 'enter'},
                    
                    {command: 'showSearch',         key: 'f', meta: true},
                    {command: 'showSearch',         key: 's', meta: true},
                    {command: 'showGotoPage',       key: 'g', meta: true},
                    {command: 'toggleMenu',         key: 'm', meta: true, annotationMode: true},
                ],
                gestures: [
                    {command: 'toggleMenu',         gesture: 'touchhold'},
                    {command: 'cycleIn',            gesture: 'pinch'},
                    {command: 'nextPage',           gesture: 'swipe', direction: 'left'},
                    {command: 'previousPage',       gesture: 'swipe', direction: 'right'}
                ]
            });
            
            var IMAGE_TILING = [1, 5];
            var IMAGE_WIDTH = 800;
            var IMAGES = {{ document|images }};

            IMAGE_TILING.each(function(t){
                var bw = t==1 ? 0 : 1;
                viewer.addImageSet(new ecs.pdfviewer.ImageSet({
                    sprite: {x: t, y: t},
                    borderWidths: {top: bw, bottom: bw, left: bw, right: bw}
                }));
            });
            
            IMAGES.each(function(image){
                if(image.width == IMAGE_WIDTH){
                    viewer.addImage(image);
                }
            });
            $(document.body).addClass('pdfviewer');
            if(Browser.Features.Touch){
                $(document.body).addClass('touch');
            }
            
            var USER_ID = {{ request.user.pk }};
            
            {{ document|annotations_for_user:user }}.each(function(a){
                viewer.addAnnotation(a.page_number - 1, new ecs.pdfviewer.Annotation(a.pk, a.text, a.x, a.y, a.width, a.height, a.author__id != USER_ID ? a.author__email : null));
            });

            viewer.gotoAnchor();
            viewer.update();
            
            /*
            var metaKeySelect = $('metaKeySelect')
            metaKeySelect.addEvent('change', function(){
                viewer.setMetaKey(metaKeySelect.value);
                $$('.metaKey').each(function(mk){
                    mk.innerHTML = metaKeySelect.value.capitalize();
                });
            });
            metaKeySelect.value = '{{ user.ecs_settings.pdfviewer_settings.metaKey }}';
            */
            $('pdfviewer_loading').dispose();

        {% else %}
            $(document.body).addClass('pdfviewer');
        {% endif %}
    });
    
    window.addEvent('domready', function(){
    {% comment %}
    TODO: Warning, this duplicates get_origin,camera.Camera & camera.install from core.html to get bugshot in pdfviewer
    {% endcomment %}

    function get_origin() {
        var re_id_axe = /[0-9a-f]{32}/;
        var x = encodeURIComponent(window.location.href).replace(/-/g, "--").replace(/%/g, "-").replace(re_id_axe, 'id');
        return x;
     }

    });
</script>

{% endblock %}

{% block htmlbody %}
{% if document|is_ready %}
<div id="pdfviewer"></div>
<div id="pdfviewer_loading">
    <div class="text"><img src="/static/images/loading.gif" width="64" height="64"/>Loading {{ document.doctype_name }}: {{ document.name }} {% if document.parent_object %} f√ºr {{ document.parent_object }}{% endif %}</div>
</div>
{% else %}
<div id="pdfviewer">
    <style>
        body, html {
            height: 100%;
        }
        h1 {
            margin-bottom: 10px;
            color: red;
        }
        .logo {
            position: absolute;
            right: 10px;
            top: 10px;
        }
        .outer {
            background-color: white;
            position: relative;
            width: 100%;
            height: 100%;
        }
        .inner {
            position: absolute;
            top: 50%;
            height: 10em;
            margin-top: -5em;
            left: 50%;
            width: 500px;
            margin-left: -250px;
            text-align: center;
        }
    </style>
    <div class="outer">
        <img class="logo" src="/static/images/logo.png" />
        <div class="inner">
            <h1>{% trans 'Your document is not ready yet.' %}</h1>
            <p><img src="/static/images/loading_small.gif"/><span style="vertical-align:top;">{% trans 'The request will be automatically repeated after 10 seconds.' %}</span></p>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
