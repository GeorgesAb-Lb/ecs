{% extends "core.html" %}

{% block menuSelection %}overview{% endblock %}

{% block htmltitle %}ECS Dashboard{% endblock %}

{% block headertitle %}
    Dashboard
{% endblock %}

{% block content %}
    <div id="dashboard"></div>
{% endblock %}

{% block jsbottom %}
  {{ block.super }}
  <script type="text/javascript">
    (function(){
    var widgets = [];
    
    function reloadAll(){
        widgets.each(function(widget){
            widget.load();
        });
    }
    
    var Widget = new Class({
        initialize: function(url){
            this.url = null;
            this.element = new Element('div', {'class': 'dashboard_widget'});
            this.element.inject($('dashboard'));
            widgets.push(this);
            this.load(url);
        },
        load: function(url, form){
            var request = new Request.HTML({
                url: url || (form && form.action) || this.url,
                method: form ? form.method : 'get',
                update: this.element,
                data: form ? form.toQueryString() : ''
            });
            if(url){
                this.url = url;
            }
            request.addEvent('success', this.onSuccess.bind(this));
            request.send();
        },
        onSuccess: function(){
            var self = this;
            this.element.getElements('form').each((function(form){
                var submit = (function(){
                    this.load(null, form);
                    return false;
                }).bind(this);
                form.addEvent('submit', submit);
                // NOTE: we have to monkeypatch submit(), because the js method does not fire an onsubmit event.
                form.submit = submit;
            }).bind(this));
            this.element.getElements('a.widget').each(function(link){
                console.log(link.href);
                link.addEvent('click', function(){
                    if(link.hasClass('popup')){
                        var popup = new ecs.Dialog(link.href, {
                            title: 'Nachricht',
                            size: {width: 700, height: 400},
                            onClose: function(){
                                reloadAll();
                            }
                        });
                        var iframe = popup.content.getFirst('iframe')
                        var makeClosable = function(i){
                            iframe.contentWindow.close = popup.close.bind(popup);
                        };
                        iframe.addEvent('load', makeClosable);
                        makeClosable();
                    }
                    else if(link.hasClass('api')){
                        var request = new Request({
                            url: link.href,
                            onSuccess: function(){
                                reloadAll();
                            }
                        });
                        request.send();
                        return false;
                    }
                    else{
                        self.load(link.href);
                        return false;
                    }
                    return false;
                });
            });
        }
    });
    window.addEvent('domready', function(){
        new Widget('{% url ecs.communication.views.outgoing_message_widget %}');
        new Widget('{% url ecs.communication.views.incoming_message_widget %}');
        new Widget('{% url ecs.tasks.views.my_tasks_widget %}');

        $$('a.popup').each(function(link){
            link.addEvent('click', function(){
                new ecs.Dialog(link.href, {
                    title: 'Nachricht',
                    size: {width: 700, height: 400},
                    onClose: function(){
                        window.location.reload();
                    }
                });
                return false;
            });
        });
    });
    })();
  </script>
{% endblock %}

