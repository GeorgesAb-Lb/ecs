{% extends 'base.html' %}
{% load compress i18n userutils core scratchpad userswitcher %}

{% block account %}
  <div class="user_data">
    <div class="user_icon"><a href="{% url 'ecs.users.views.profile' %}">User</a></div> 
    <div class="user_name"><a href="{% url 'ecs.users.views.profile' %}">{{ user }}</a>
      <span class="user_logout"><a href="/accounts/logout">Logout</a></span>
    </div>
    
  </div>
  {% userswitcher %}
{% endblock %}

{% block usertoolbar %}
  <div class="searchbox">
    <form action="{% url 'ecs.core.views.submissions.all_submissions' %}" method="get" enctype="multipart/form-data">
      <input type="text" name="keyword" value="{% block quicksearch_keyword %}{% endblock %}"  placeholder="Suche" />
      <input type="submit" value="" title="suchen" />
    </form>
  </div>
  <a href="" id="help_button" class="help_trigger icon_help" title="{% trans "Click here to get help." %}">help</a>
  {% get_scratchpad as scratchpad %}
  <a href="{% url 'ecs.scratchpad.views.popup' %}{% if submission %}?submission={{ submission.pk }}{% endif %}" id="scratchpad_button" class="open-in-popup{% if not scratchpad or scratchpad.is_empty %} empty{% endif %}" title="{% if submission %}{% blocktrans with submission|ec_number as ec_number %}Show my scratchpad for submission {{ ec_number }}{% endblocktrans %}{% else %}{% trans "Show my scratchpad" %}{% endif %} {% if not scratchpad or scratchpad.is_empty %} ({% trans "Empty" %}){% endif %}">S</a>
  {% if user|has_flag:"is_internal" %}
    {% get_breadcrumbs as crumbs %}
    {% if crumbs %}
    <div class="breadcrumbs">
      {% for submission in crumbs %}
        <a href="{% url 'view_submission' submission_pk=submission.pk %}">{{ submission|ec_number }}{% if not forloop.last %},{% endif %}</a>
      {% endfor %}
    </div>
    {% endif %}
  {% endif %}
{% endblock %}
        
{% block usermenu %}
  <ul>
    <li class="main_item"><a href="{% url 'ecs.dashboard.views.view_dashboard' %}">{% trans "Dashboard" %}</a></li>
    <li class="main_item"><a href="{% url 'ecs.communication.views.list_threads' %}">{% trans "Communication" %}</a></li>
    {% if user.profile.has_explicit_workflow %}
        <li class="main_item"><a href="{% url 'ecs.tasks.views.task_list' %}">{% trans "Tasks" %}</a></li>
    {% endif %}
    <li>
      <span class="togglers">{% trans "Studies" %}</span>
      <ul class="elements">
          {% if user|has_flag:"is_internal" or user|is_member_of:"EC-Thesis Review Group" %}
              <li><a href="{% url 'ecs.core.views.submissions.all_submissions' %}">{% trans "All Studies" %}</a></li>
          {% endif %}
          {% if user|has_assigned_submissions %}
              <li><a href="{% url 'ecs.core.views.submissions.assigned_submissions' %}">{% trans "Assigned Studies" %}</a></li>
          {% endif %}
          {% if user|has_submissions %}
              <li><a href="{% url 'ecs.core.views.submissions.my_submissions' %}">{% trans "My Studies" %}</a></li>
          {% endif %}
          <li><a href="{% url 'ecs.core.views.submissions.create_submission_form' %}">{% trans "New Submission" %}</a></li>
          <li><a href="{% url 'ecs.core.views.submissions.import_submission_form' %}">{% trans "Import" %}</a></li>
      </ul>
    </li>
    <li>
      <span class="togglers">{% trans "Study Notifications" %}</span>
      <ul class="elements">
          <li><a href="{% url 'ecs.notifications.views.open_notifications' %}">{% trans 'Open Notifications' %}</a></li>
          <li><a href="{% url 'ecs.notifications.views.select_notification_creation_type' %}">{% trans 'New Notification' %}</a></li>
      </ul>
    </li>
    {% if user|has_flag:"is_internal" or user|has_flag:"is_board_member" or user|has_flag:"is_resident_member" %}
        <li>
          <span class="togglers">{% trans "Meetings" %}</span>
          <ul class="elements">
                <li><a href="{% url 'ecs.meetings.views.next' %}">{% trans "Next Meeting" %}</a></li>
                {% if user|has_flag:"is_internal" or user|has_flag:"is_resident_member" %}
                    <li><a href="{% url 'ecs.meetings.views.upcoming_meetings' %}">{% trans "Upcoming Meetings" %}</a></li>
                    <li><a href="{% url 'ecs.meetings.views.past_meetings' %}">{% trans "Past Meetings" %}</a></li>
                    {% if user|is_member_of:"EC-Office" %}
                        <li><a href="{% url 'ecs.meetings.views.create_meeting' %}">{% trans "New Meeting" %}</a></li>
                    {% endif %}
                {% endif %}
          </ul>
        </li>
    {% endif %}
    {% if user|has_flag:"is_internal" or user|has_flag:"is_developer" %}
        <li>
          <span class="togglers">{% trans "Administration" %}</span>
          <ul class="elements">
                {% if user|has_flag:"is_internal" %}
                      {% if user|is_member_of:"EC-Office" or user|is_member_of:"EC-Executive Board Group" %}
                          <li><a href="{% url 'ecs.users.views.administration' %}">{% trans "User Administration" %}</a></li>
                          <li><a href="{% url 'ecs.billing.views.submission_billing' %}">{% trans "Accounting of fees" %}</a></li>
                          <li><a href="{% url 'ecs.billing.views.external_review_payment' %}">Gutachter Bezahlung</a></li>
                          <li><a href="{% url 'ecs.core.views.administration.advanced_settings' %}">{% trans 'Advanced Settings' %}</a></li>
                      {% endif %}
                      <li><a href="{% url 'ecs.statistics.views.stats' %}">{% trans 'Statistics' %}</a></li>
                      <li><a href="{% url 'ecs.boilerplate.views.list_boilerplate' %}">{% trans 'Boilerplates' %}</a></li>
                      {% if user|is_member_of:'EC-Signing Group' or user|is_member_of:'EC-Office' %}
                          <li><a href="{% url 'ecs.pki.views.cert_list' %}">{% trans 'PKI' %}</a></li>
                      {% endif %}
                {% endif %}   
          </ul>
        </li>
    {% endif %}
  </ul>
{% endblock %}

{% block header %}
    {{ block.super }}
    {% if request.task_management.form %}
        <div id="headerworkflow">
        {% with request.task_management.form as form %}
            {% include 'tasks/manage_task.html' %}
        {% endwith %}
        </div>
        <a id="toggle_headerworkflow" title="{% trans 'Task Management Widget verstecken/wiederherstellen' %}">&lt;</a>
    {% endif %}
{% endblock %}

{% block headernav %}
    {% if user.profile.is_indisposed %}
    <div>
      {% url 'ecs.users.views.profile' as profile_url %}
      {% blocktrans with profile_url as profile_url %}
          You are currently marked indisposed. To reclaim your tasks, please visit your <a href="{{ profile_url }}">profile</a>.
      {% endblocktrans %}
    </div>
    {% endif %}
{% endblock %}

{% block jsbottom %}
  {{ block.super }}
  <script type="text/javascript">
    var accordion_choices = [
        'submissions',
        'notifications',
{% if user|has_flag:"is_internal" or user|has_flag:"is_board_member" %}
        'meetings',
{% endif %}
{% if user|has_flag:"is_internal" or user|has_flag:"is_executive_board_member" %}
        'administration',
{% endif %}
        'demo'
    ];

    var accordionitem_name = '{% block menuSelection %}overview{% endblock %}';
    var accordion_items = {
      'overview': -1,
      'communication': -1,
{% if user.profile.has_explicit_workflow %}
      'tasks': -1,
{% endif %}
    };

    /* prevent "Error calling method on NPObject." exception in chromium + java plugin */
    var selectors_utils_filter = Selectors.Utils.filter;
    Selectors.Utils.filter = function(item, parsed, local){
        try {
            return selectors_utils_filter(item, parsed, local);
        } catch (e) {
            console.log(e);
            return false;
        }
    };

    for(var i=0; i < accordion_choices.length; i++) {
        accordion_items[accordion_choices[i]] = i;
    }

    var accordionitem = accordion_items[accordionitem_name];
    if(typeof(accordionitem) === 'undefined') {
      var accordionitem = accordion_items['overview'];
    }
    
    window.addEvent('domready', function(){
      {% if request.task_management.form %}
          var headerworkflow = $('headerworkflow');
          var w = new ecs.widgets.TaskWidget(headerworkflow, {});
          var toggle_headerworkflow = $('toggle_headerworkflow');
          toggle_headerworkflow.addEvent('click', function(){
            var visible = headerworkflow.isVisible();
            headerworkflow.toggle();
            toggle_headerworkflow.toggleClass('collapsed', !visible);
            toggle_headerworkflow.innerHTML = visible ? '&gt;' : '&lt;';
            w.updateContentHeight();
          });
      {% endif %}

      // accordions
      var toggles = $$('.togglers');
      var content = $$('.elements');      

      $$('#usermenu .elements').show();
      var AccordionObject = new Accordion(toggles, content, { show: accordionitem , duration: 200});
      
      // single login popup
      {% if user.profile.get_single_login_enforced %}
        ecs.messages.alert('{% trans 'Single Login enforced' %}', '{% trans 'The old session is now void.' %}');
      {% endif %}
      
      // message popups
      {% load communication tasks %}
      {% fetch_messages as new_messages %}
      {% fetch_tasks as new_tasks %}
      var newMessages = [{% for message in new_messages %}{'sender': '{{ message.sender|escapejs }}', 'subject': '{{ message.thread.subject|escapejs }}'}{% if not forloop.last %}, {% endif %}{% endfor %}];
      var newTasks = [{% for task in new_tasks %}{'__str__': '{{ task|escapejs }}'}{% if not forloop.last %}, {% endif %}{% endfor %}];

      var message_popup_body = '';
      newMessages.each(function(msg) {
        message_popup_body += '<strong>{subject}</strong> - {sender}<br />\n'.substitute(msg);
      });

      {% if new_messages|length %}
        ecs.messages.alert('{% trans "New Messages" %} ({{ new_messages|length }})', message_popup_body);
      {% endif %}

      newTasks.each(function(task){
          ecs.messages.alert('Neue Aufgabe', '<strong>{__str__}</strong>'.substitute(task));
      });
      
      {% for message in messages %}
          ecs.messages.alert('{{ message.tags|escapejs }}', '{{ message|escapejs }}')
      {% endfor %}
      
      window.openHelpPage = function(e){
          {% if request.tracking_data.view %}
          var url = '{% url 'ecs.help.views.find_help' view_pk=request.tracking_data.view.pk %}';
          if(e && e.shift){
              url = '{% url 'ecs.help.views.edit_help_page' view_pk=request.tracking_data.view.pk %}';
          }
          if(window.location.hash){
              url += '?anchor=' + encodeURIComponent(window.location.hash.substring(1));
          }
          {% else %}
          var url = '{% url 'ecs.help.views.index' %}';
          {% endif %}
          var win = window.open(url, 'ecshelp');
          win.focus();
          return false;
      };
      
      $('help_button').addEvent('click', window.openHelpPage);

    });
  </script>
{% endblock %}
