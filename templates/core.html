{% extends 'shell.html' %}
{% load compress i18n staticfiles widget_tweaks %}
{% load alert communication core scratchpad userswitcher userutils version_tag %}

{% block htmlcss %}
    {{ block.super }}
    {% compress css %}
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/base.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/core.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/forms.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/readonly.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/notification.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/diff.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/meetings.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/communication.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/dashboard.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/billing.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/administration.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/boilerplate.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/signature.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/statistics.scss' %} />
        <link rel="stylesheet" type="text/x-scss" href={% static 'css/ecs/tags.scss' %} />
    {% endcompress %}
{% endblock %}

{% block htmlbody %}
    <nav class="navbar navbar-light bg-faded pb-0 mb-0">
        <a class="navbar-brand" href="{% url 'ecs.dashboard.views.view_dashboard' %}">
            <img src="{% url 'ecs.core.views.logo' %}" alt="Logo"/>
        </a>
        <ul class="nav navbar-nav w-100">
            <li class="nav-item">
                <a href="{% url 'ecs.dashboard.views.view_dashboard' %}" class="nav-link text-primary">
                    {% trans "Dashboard" %}
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-primary" href="{% url 'ecs.communication.views.list_threads' %}">
                    {% trans "Communication" %}
                    ({% unread_msg_count %})
                </a>
            </li>
            {% if user.profile.show_task_widget %}
                <li class="nav-item">
                    <a class="nav-link text-primary" href="{% url 'ecs.tasks.views.task_list' %}">
                        {% trans "Tasks" %}
                    </a>
                </li>
            {% endif %}
            <li class="nav-item dropdown">
                <a id="studiesMenu" class="nav-link text-primary dropdown-toggle" data-toggle="dropdown" href="#">
                    {% trans "Studies" %}
                </a>
                <div class="dropdown-menu">
                    {% if user.profile.is_internal %}
                        <a class="dropdown-item" href="{% url 'ecs.core.views.submissions.all_submissions' %}">
                            {% trans "All Studies" %}
                        </a>
                    {% endif %}
                    {% if user|has_assigned_submissions %}
                        <a class="dropdown-item" href="{% url 'ecs.core.views.submissions.assigned_submissions' %}">
                            {% trans "Assigned Studies" %}
                        </a>
                    {% endif %}
                    {% if user|has_submissions %}
                        <a class="dropdown-item" href="{% url 'ecs.core.views.submissions.my_submissions' %}">
                            {% trans "My Studies" %}
                        </a>
                    {% endif %}
                    <a class="dropdown-item" href="{% url 'ecs.core.views.submissions.create_submission_form' %}">
                        {% trans "New Submission" %}
                    </a>
                    <a class="dropdown-item" href="{% url 'ecs.core.views.submissions.import_submission_form' %}">
                        {% trans "Import" %}
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{% url 'ecs.notifications.views.open_notifications' %}">
                        {% trans 'Open Notifications' %}
                    </a>
                    <a class="dropdown-item" href="{% url 'ecs.notifications.views.select_notification_creation_type' %}">
                        {% trans 'New Notification' %}
                    </a>
                </div>
            </li>
            {% if user.profile.is_internal or user.profile.is_board_member or user.profile.is_resident_member or user.profile.is_omniscient_member %}
                <li class="nav-item dropdown">
                    <a id="meetingsMenu" class="nav-link dropdown-toggle text-primary" data-toggle="dropdown" href="#">
                        {% trans "Meetings" %}
                    </a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="{% url 'ecs.meetings.views.next' %}">
                            {% trans "Next Meeting" %}
                        </a>
                        {% if user.profile.is_internal or user.profile.is_resident_member or user.profile.is_omniscient_member %}
                            <a class="dropdown-item" href="{% url 'ecs.meetings.views.upcoming_meetings' %}">
                                {% trans "Upcoming Meetings" %}
                            </a>
                        {% endif %}
                        {% if user.profile.is_internal %}
                            <a class="dropdown-item" href="{% url 'ecs.meetings.views.past_meetings' %}">
                                {% trans "Past Meetings" %}
                            </a>
                        {% endif %}
                        {% if user|is_member_of:"EC-Office" %}
                            <a class="dropdown-item" href="{% url 'ecs.meetings.views.create_meeting' %}">
                                {% trans "New Meeting" %}
                            </a>
                        {% endif %}
                    </div>
                </li>
            {% endif %}
            <li class="nav-item">
                <a href="{% static 'help/index.html' %}" target="_blank" class="nav-link py-0 fa fa-question-circle-o fa-2x text-primary" title="{% trans "Click here to get help." %}"></a>
            </li>
            <li class="nav-item">
                {% get_scratchpad as scratchpad %}
                <a href="{% url 'ecs.scratchpad.views.popup' %}{% if submission %}?submission={{ submission.pk }}{% endif %}" class="nav-link py-0 scratchpad fa fa-sticky-note{% if not scratchpad or scratchpad.is_empty %}-o{% endif %} fa-2x text-primary" title="{% if submission %}{% blocktrans with submission|ec_number as ec_number %}Show my scratchpad for submission {{ ec_number }}{% endblocktrans %}{% else %}{% trans "Show my scratchpad" %}{% endif %}"></a>
            </li>
            {% if user.profile.is_internal %}
                <li class="nav-item dropdown">
                    <a id="adminMenu" class="nav-link dropdown-toggle py-0 text-primary" data-toggle="dropdown" href="#" title="{% trans "Administration" %}">
                        <span class="fa fa-cog fa-2x text-primary py-0"></span>
                    </a>
                    <div class="dropdown-menu">
                        {% if user|is_member_of:"EC-Office" or user|is_member_of:"EC-Executive Board Member" %}
                            <a class="dropdown-item" href="{% url 'ecs.users.views.administration' %}">
                                {% trans "User Administration" %}
                            </a>
                            <a class="dropdown-item" href="{% url 'ecs.billing.views.submission_billing' %}">
                                {% trans "Accounting of fees" %}
                            </a>
                            <a class="dropdown-item" href="{% url 'ecs.billing.views.external_review_payment' %}">
                                Gutachter Bezahlung
                            </a>
                            <a class="dropdown-item" href="{% url 'ecs.core.views.administration.advanced_settings' %}">
                                {% trans 'Advanced Settings' %}
                            </a>
                        {% endif %}
                        <a class="dropdown-item" href="{% url 'ecs.statistics.views.stats' %}">
                            {% trans 'Statistics' %}
                        </a>
                        <a class="dropdown-item" href="{% url 'ecs.boilerplate.views.list_boilerplate' %}">
                            {% trans 'Boilerplates' %}
                        </a>
                        <a class="dropdown-item" href="{% url 'ecs.pki.views.cert_list' %}">
                            {% trans 'PKI' %}
                        </a>
                        <a class="dropdown-item" href="{% url 'ecs.tags.views.index' %}">
                            {% trans "Tags" %}
                        </a>
                    </div>
                </li>
            {% endif %}
            <li class="dropdown nav-item">
                <a href="#" id="userMenu" class="nav-link py-0 dropdown-toggle text-primary" data-toggle="dropdown" title="{% trans "User" %}">
                    <span class="fa fa-user fa-2x text-primary"></span>
                </a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="{% url 'ecs.users.views.profile' %}">
                        {{ user }}
                    </a>
                    <a class="dropdown-item" href="/accounts/logout">
                        Logout
                    </a>
                </div>
            </li>
            <li class="nav-item float-xs-right">
                <form action="{% url 'ecs.core.views.submissions.all_submissions' %}" method="get">
                    <div class="input-group">
                        <input type="text" class="form-control" name="keyword" value="{% block quicksearch_keyword %}{% endblock %}" placeholder="Suche">
                        <span class="input-group-btn">
                            <button class="btn btn-outline-success" type="submit" title="{% trans "Search" %}"><i class="fa fa-search"></i></button>
                        </span>
                    </div>
                </form>
            </li> 
        </ul>
    </nav>
    <div class="px-1 bg-faded">
        {% userswitcher %}
        <small class="float-xs-right">
            {% if user.profile.is_internal %}
                {% get_breadcrumbs as crumbs %}
                {% if crumbs %}
                    {% for submission in crumbs %}
                        <a href="{% url 'view_submission' submission_pk=submission.pk %}">
                            {{ submission|ec_number }} | 
                        </a>
                    {% endfor %}
                {% endif %}
            {% endif %}
            {% current_version %}
        </small>
    </div>
        
    <div id="header" class="bg-faded p-1">
        <h1 id="headertitle">{% block headertitle %}{% endblock %}</h1>
        <div id="headernav">
            {% block headernav %}
                {% if user.profile.is_indisposed %}
                <div>
                  {% url 'ecs.users.views.profile' as profile_url %}
                  {% blocktrans with profile_url as profile_url %}
                      You are currently marked indisposed. To reclaim your tasks, please visit your <a href="{{ profile_url }}">profile</a>.
                  {% endblocktrans %}
                </div>
                {% endif %}
            {% endblock %}
        </div>
        {% block header_actions %}
        {% endblock %}

        {% if request.task_management.form %}
            {% include 'tasks/manage_task.html' with form=request.task_management.form %}
        {% endif %}
    </div>

    <div id="content" class="container-fluid my-1">
        {% for message in messages %}
            <div class="alert alert-{{ message.level|level2alert }} alert-dismissible text-xs-center">
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
                {{ message }}
            </div>
        {% endfor %}

        {% block content %}
        {% endblock %}
    </div>
{% endblock %}

{% block jsbottom %}
    {{ block.super }}

    {% compress js %}
        <script type="text/javascript" src={% static 'js/ecs/__init__.js' %}></script>
        <script type="text/javascript" src={% static 'js/ecs/TabController.js' %}></script>
        <script type="text/javascript" src={% static 'js/ecs/TabbedForm.js' %}></script>
        <script type="text/javascript" src={% static 'js/ecs/InlineFormset.js' %}></script>
        <script type="text/javascript" src={% static 'js/ecs/fieldhistory.js' %}></script>
        <script type="text/javascript" src={% static 'js/ecs/textarea.js' %}></script>
        <script type="text/javascript" src={% static 'js/ecs/textarea.toolbarItems.js' %}></script>
        <script type="text/javascript" src={% static 'js/ecs/utils.js' %}></script>
        <script type="text/javascript" src={% static 'js/ecs/widgets.js' %}></script>
        <script type="text/javascript" src={% static 'js/ecs/tasks.js' %}></script>
        <script type="text/javascript" src={% static 'js/ecs/communication.js' %}></script>
    {% endcompress %}

    <script type="text/javascript">
        $(function(){
            var selected = '{% block menuSelection %}dashboard{% endblock %}';
            $('#usermenu .nav-link.' + selected).addClass('active');

            {% if request.task_management.form %}
                ecs.init_task_form();
            {% endif %}

            $('#userswitcher_input').select2({placeholder: null});

            $(document).on('click', 'a.scratchpad', function(ev) {
                ev.preventDefault();

                var modal = ecs.popup();
                modal.find('.modal-content').load($(this).attr('href'), function() {
                    var textarea = modal.find('textarea[name="text"]');
                    var len = textarea.val().length;
                    textarea.focus();
                    textarea.get(0).setSelectionRange(len, len);
                });

                modal.on('hide.bs.modal', function() {
                    var form = modal.find('form');
                    if (form.length)
                        $.post(form.attr('action'), form.serialize());
                });

                modal.on('click', 'a', function(ev) {
                    ev.preventDefault();

                    var form = modal.find('form');
                    if (form.length)
                        $.post(form.attr('action'), form.serialize());

                    modal.find('.modal-content').load($(this).attr('href'));
                });
            });

            $.fn.select2.defaults.set('placeholder', '\u2026');
            $.fn.select2.defaults.set('dropdownAutoWidth', true);
        });
    </script>
{% endblock %}
