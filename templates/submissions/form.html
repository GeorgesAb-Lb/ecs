{% extends "submissions/base_form.html" %}
{% load core i18n userutils %} 

{% block headertitle %}
    {% if notification_type %}
      {{ notification_type.name }} f√ºr {{ submission }}
    {% endif %}
{% endblock %}

{% block header_actions %}
    {{ block.super }}
    <div class="header_actions">
      <a href="" id="save-button" class="button_save">{% trans "Save" %}</a>
      <a href="" id="validate-button" class="button_validate">{% trans "Validate" %}</a>
      <a href="" id="submit-button" class="button_submit">
        {% if submission and submission.current_submission_form %}
            {% if notification_type %}
                {% trans "Submit Amendment" %}
            {% else %}
                {% trans "Resubmit" %}
            {% endif %}
        {% else %}
            {% trans "Submit" %}
        {% endif %}
      </a>
    </div>
{% endblock %}

{% block content %}
    <form action="" method="post" enctype="multipart/form-data" class="form_main">
        {{ block.super }}
        <input type="submit" name="validate" value="validate" class="hidden" />
        <input type="submit" name="submit" value="submit" class="hidden" />
    </form>
{% endblock %}

{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript"> 
        window.addEvent('domready', function(){
            var formsets = [
                '{{ measure_formset.prefix }}', 
                '{{ routinemeasure_formset.prefix }}', 
                '{{ nontesteduseddrug_formset.prefix }}', 
                '{{ foreignparticipatingcenter_formset.prefix }}', 
            ].map(function(prefix){
                console.log(prefix);
                return new ecs.InlineFormSet($(prefix + '_formset'), {
                    prefix: prefix
                });
            });
            
            $('save-button').addEvent('click', function(){
                ecs.mainForm.save();
                return false;
            });
            $('validate-button').addEvent('click', function(){
                ecs.mainForm.submit('validate');
                return false;
            });
            $('submit-button').addEvent('click', function(){
                ecs.mainForm.submit('validate');
                return false;
            });
            
            {% if valid and not half_baked_documents and user|has_flag:'approved_by_office' %}
                new MooDialog.Confirm('{% if notification_type %}{% trans "You filled out the form correctly. Do you want to create a notification now?" %}{% else %}{% trans "You filled out the form correctly. Do want to submit the study?" %}{% endif %}', function(){
                    ecs.mainForm.submit('submit');
                });
            {% endif %}
            {% if valid and half_baked_documents and user|has_flag:'approved_by_office' %}
                new MooDialog.Error('{% trans "You cannot submit study if there are unready documents. If you want to submit the study regardless of the unready documents, delete them." %}');
            {% endif %}
            {% if valid and not user|has_flag:'approved_by_office' %}
                new MooDialog.Error('{% trans "You cannot submit studies yet. Please wait until the office has approved your account." %}');
            {% endif %}


            {# document upload magic #}

            var file_field = $('id_document-file');
            var name_field = $('id_document-name');
            file_field.addEvent('change', function() {
                var dot_offset = file_field.value.lastIndexOf('.');
                var name = file_field.value;
                if (dot_offset >= 0) {
                    name = file_field.value.substring(0, dot_offset);
                }
                if (!name_field.getAttribute('readonly')) {
                    name_field.value = name;
                }

                var errorlist = file_field.getNext('.errorlist');
                if (errorlist) {
                    errorlist.hide();
                }
            });

        });
    </script>
{% endblock %}
