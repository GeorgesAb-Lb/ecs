{% extends "submissions/base_form.html" %}
{% load core i18n userutils %} 

{% block htmltitle %}
    … |
    {% if notification_type %}
      {{ notification_type.name }} für {{ submission|ec_number }}
    {% else %}
        {% if submission %}{{ submission|ec_number }}{% else %}{% trans "New Submission" %}{% endif %}
    {% endif %}
    | {{ block.super }}
{% endblock %}
{% block headertitle %}
    {% if notification_type %}
      {{ notification_type.name }} für {{ submission|ec_number }}
    {% else %}
        {% if submission %}{{ submission|ec_number }}{% endif %}
    {% endif %}
{% endblock %}

{% block header_actions %}
    {{ block.super }}
    <div class="header_actions">
      <a href="" id="save-button" class="button_save">{% trans "Save" %}</a>
      <a href="" id="submit-button" class="button_submit">
        {% if submission and submission.current_submission_form %}
            {% if notification_type %}
                {% trans "Submit Amendment" %}
            {% else %}
                {% trans "Resubmit" %}
            {% endif %}
        {% else %}
            {% trans "Submit" %}
        {% endif %}
      </a>
    </div>
{% endblock %}

{% block content %}
    <form action="" method="post" enctype="multipart/form-data" class="form_main">
        {{ block.super }}
        <input type="submit" name="validate" value="validate" class="hidden" />
        <input type="submit" name="submit" value="submit" class="hidden" />
    </form>
{% endblock %}

{% block section_6_1 %}
    <div class="hint">Bitte beachten Sie die <a href="javascript:void(openHelpPage())">Hinweise in den Hilfeseiten</a></div>
    {{ block.super }}
{% endblock %}

{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript"> 
        window.addEvent('domready', function(){
            var formsets = [
                ['{{ measure_formset.prefix }}', '{% trans "Add new measure" %}'],
                ['{{ routinemeasure_formset.prefix }}', '{% trans "Add new measure" %}'],
                ['{{ nontesteduseddrug_formset.prefix }}', '{% trans "Add new measure" %}'],
                ['{{ foreignparticipatingcenter_formset.prefix }}', '{% trans "Add new foreign particiating centre" %}']
            ].map(function(el){
                var prefix = el[0];
                var addButtonText = el[1];
                console.log(prefix);
                console.log(addButtonText);
                return new ecs.InlineFormSet($(prefix + '_formset'), {
                    prefix: prefix,
                    addButtonText: addButtonText
                });
            });

            new ecs.FormFieldController([
                    'id_invoice_name', 'id_invoice_contact_gender', 'id_invoice_contact_title', 'id_invoice_contact_first_name',
                    'id_invoice_contact_last_name', 'id_invoice_address', 'id_invoice_zip_code', 'id_invoice_city', 'id_invoice_phone',
                    'id_invoice_fax', 'id_invoice_email', 'id_invoice_uid'
                ], {
                    sources: ['id_invoice_differs_from_sponsor'],
                    auto: function(values, initial){
                        var requiredFields = [
                            'id_invoice_name', 'id_invoice_address', 'id_invoice_zip_code', 'id_invoice_city', 'id_invoice_phone',
                            'id_invoice_email'
                        ];

                        if(values[0]){
                            $('tabs-4').getElement('.fieldset_2').show();
                            this.setDisabled(false);
                        } else {
                            $('tabs-4').getElement('.fieldset_2').hide();
                            this.setDisabled(true);
                        }

                        requiredFields.map($).each(function(f){
                            this.requireField(f, values[0]);
                        }, this);
                    }
            });
            
            $('save-button').addEvent('click', function(){
                ecs.mainForm.save();
                return false;
            });
            $('submit-button').addEvent('click', function(){
                ecs.mainForm.submit('validate');
                return false;
            });
            
            {% if valid and allows_edits %}
                new MooDialog.Confirm('{% if notification_type %}{% trans "You filled out the form correctly. Do you want to create a notification now?" %}{% else %}{% trans "You filled out the form correctly. Do want to submit the study?" %}{% endif %}', function(){
                    ecs.mainForm.submit('submit');
                }, null, {
                    okText: '{% if notification_type %}{{ _("Create Notification")|escapejs }}{% else %}{{ _("Submit")|escapejs }}{% endif %}',
                    cancelText: '{% if notification_type %}{{ _("Cancel")|escapejs }}{% else %}{{ _("Don't Submit")|escapejs }}{% endif %}'
                });
            {% endif %}
            {% if valid and not allows_edits %}
                new MooDialog.Error('{{ _("This form can't be submitted at the moment.")|escapejs }}');
            {% endif %}
        });
    </script>
{% endblock %}
