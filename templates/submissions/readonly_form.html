{% extends "submissions/base_form.html" %}
{% load core i18n userutils %} 


{% block headertitle %}
  {{ submission_form.submission|ec_number }} {{ submission_form.submission.project_title_display|default:'<em>Ohne Titel</em>' }}
{% endblock %}


{% block header_actions %}
    {{ block.super }}
    <div class="header_actions">
    {% if submission_form.presenter == request.user and submission_form.submission.current_submission_form == submission_form %}
        {% if not submission_form.submission.has_final_vote %}
            <a href="{% url ecs.core.views.copy_submission_form submission_form_pk=submission_form.pk %}">{% trans 'Edit' %}</a>
        {% else %}
            {% for notification_type in diff_notification_types %}
                <a href="{% url ecs.core.views.copy_submission_form submission_form_pk=submission_form.pk,notification_type_pk=notification_type.pk %}">{{ notification_type.name }}</a>
            {% endfor %}
        {% endif %}
    {% endif %}
    {% for checklist, checklist_review_form in checklist_reviews %}
        {% if not checklist_review_form.readonly %}
            <a class="review button_save" id="save_checklist_{{ checklist.pk }}_review_form" href="">{% blocktrans with checklist.blueprint.name as review %}save {{ review }}{% endblocktrans %}</a>
            {% if checklist_review_form.complete_task %}
                <a class="review button_submit" id="close_checklist_{{ checklist.pk }}_review_form" href="">{% blocktrans with checklist.blueprint.name as review %}complete {{ review }}{% endblocktrans %}</a>
            {% endif %}
        {% endif %}
    {% endfor %}
    </div>
{% endblock %}


{% block headernav %}
  <div class="readonly">
    <ul class="tab_header_groups">
    {% block tab_header_groups %}
        <li>
            <a href="#">{% trans "General" %}</a>
            <ul class="tab_headers">
                <li>
                    <a href="#status_tab">{% trans 'Status' %}</a>
                </li>
                {% if user.get_profile.has_explicit_workflow %}
                    <li>
                        <a href="#workflow_tab">{% trans 'Workflow' %}</a>
                    </li>
                    {% if user|has_flag:'internal' %}
                        <li>
                            <a href="#workflow_log">{% trans 'Workflow Log' %}</a>
                        </li>
                    {% endif %}
                {% endif %}
                <li>
                    <a href="#involved_parties_tab">{% trans 'Involved Parties' %}</a>
                </li>
            </ul>
        </li>

        {{ block.super }}

        {% if show_reviews %}
        <li>
            <a href="#">{% trans "Activities" %}</a>
            <ul class="tab_headers">
                {% if categorization_review_form %}
                    <li{% if not categorization_review_form.readonly %} class="readonly_review active"{% endif %}>
                        <a href="#categorization_review_tab">{% trans "Categorization Review" %}</a>
                    </li>
                {% endif %}
                {% for checklist, checklist_review_form in checklist_reviews %}
                    <li{% if not checklist_review_form.readonly %} class="readonly_review active"{% endif %}>
                        <a href="#checklist_{{ checklist.pk }}_review_form">{{ checklist }}</a>
                    </li>
                {% endfor %}
            </ul>
        </li>
        {% endif %}
        {% if user|has_flag:'internal' %}
        <li>
            <a href="#">{% trans "Votes" %}</a>
            <ul class="tab_headers">
                {% if show_reviews %}
                {% if vote_review_form or b2_vote_review_form %}
                    {% if b2_vote_review_form %}
                        <li class="active">
                            <a href="#b2vote_review_tab">B2 Votum</a>
                        </li>
                    {% else %}
                        <li{% if not vote_review_form.readonly %} class="readonly_review active"{% endif %}>
                            <a href="#vote_review_tab">Votum</a>
                        </li>
                    {% endif %}
                {% endif %}
                {% endif %}
                <li><a href="#published_votes_tab">{% trans "Published Votes" %}</a></li>
            </ul>
        </li>
        {% endif %}
        <li>
            <a href="#">{% trans "Notifications" %}</a>
            <ul class="tab_headers">
                <li><a href="#pending_notifications_tab">{% trans "Pending Notifications" %}</a></li>
                <li><a href="#answered_notifications_tab">{% trans "Answered Notifications" %}</a></li>
            </ul>
        </li>
        <li>
            <a href="#">{% trans "Communication" %}</a>
            <ul class="tab_headers">
                <li><a href="#communication_tab">{% trans "My Communication" %}</a></li>
                {% if user|has_flag:'internal' %}
                    <li><a href="#communication_overview_tab">{% trans "Communication Overview" %}</a></li>
                {% endif %}
            </ul>
        </li>
    {% endblock %}
    </ul>
  </div>
{% endblock %}

{% block content %}
    <div class="readonly">
        {{ block.super }}
    </div>
{% endblock %}

{% block tabs %}
    <div id="status_tab">
        {% include 'submissions/tabs/status.html' %}
    </div>
    <div id="involved_parties_tab">
        {% include 'submissions/tabs/involved_parties.html' %}
    </div>
    <div id="pending_notifications_tab" class="tab">
        <h3>{% trans "Open Notifications" %}</h3>
        {% if open_notifications %}
            <ul>
                {% for notification in open_notifications %}
                    <li>
                        <a href="{% url ecs.notifications.views.view_notification notification_pk=notification.pk %}">{{ notification }}</a>
                        von {{ notification.user }} am {{ notification.timestamp|date:'d.m.Y' }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>{% trans "There are no open notifications." %}</p>
        {% endif %}
        {% if submission_form.presenter == request.user %}
            <a href="{% url ecs.notifications.views.select_notification_creation_type %}" class="button_submit">{% trans "Create a new notification" %}</a>
        {% endif %}
    </div>
    <div id="answered_notifications_tab" class="tab">
        <h3>{% trans "Answered Notifications" %}</h3>
        {% if answered_notifications %}
            <ul>
                {% for notification in answered_notifications %}
                    <li>
                        <a href="{% url ecs.notifications.views.view_notification notification_pk=notification.pk %}">{{ notification }}</a>
                        von {{ notification.user }} am {{ notification.timestamp|date:'d.m.Y' }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>{% trans "There are no answered notifications." %}</p>
        {% endif %}
        {% if submission_form.presenter == request.user %}
            <a href="{% url ecs.notifications.views.select_notification_creation_type %}" class="button_submit">{% trans "Create a new notification" %}</a>
        {% endif %}
    </div>
    {% if user|has_flag:'internal' %}
    {% if b2_vote_review_form or vote_review_form %}
        {% if b2_vote_review_form %}
            <div id="b2vote_review_tab" class="tab">
                <h3>B2 Votum der Sitzung {{ vote.top.meeting.title }} am {{ vote.top.meeting.start|date:'d.m.Y' }} ({{ vote.top }})</h3>
                <h4>Upgrade auf B1</h4>
                <form action="" method="post">
                    {% with b2_vote_review_form as review_form %}
                        {% include 'submissions/review_form.inc' %}
                    {% endwith %}
                </form>
            </div>
        {% else %}
            <div id="vote_review_tab" class="tab">
                {% block vote_review_tab_content %}
                    <h3>Votum der Sitzung {{ vote.top.meeting.title }} am {{ vote.top.meeting.start|date:'d.m.Y' }} ({{ vote.top }})</h3>
                    <form action="" method="post">
                        {% with vote_review_form as review_form %}
                            {% include 'submissions/review_form.inc' %}
                        {% endwith %}
                    </form>
                {% endblock %}
            </div>
        {% endif %}
    {% endif %}
    <div id="published_votes_tab" class="tab">
        <h3>{% trans "Published Votes" %}</h3>
        {% if published_votes %}
            <ul>
                {% for vote in published_votes %}
                    <li>{{ vote.result_text }}{% if vote.top %} (in der Sitzung am {{ vote.top.meeting.start|date:'d.m.Y' }}){% endif %}</li>
                    <a href="{% url ecs.core.views.download_signed_vote vote_pk=vote.pk %}" target="_blank">{% trans "Download" %}</a>
                {% endfor %}
            </ul>
        {% else %}
            <p>{% trans "There are no published votes." %}</p>
        {% endif %}
    </div>
    {% endif %}
    
    {% if categorization_review_form %}
        <div id="categorization_review_tab" class="tab">
            {% block categorization_review_tab_content %}
                {% if categorization_task and categorization_review_form.readonly %}
                    <a href="{% url ecs.tasks.views.reopen_task task_pk=categorization_task.pk %}">{% trans 'Reopen' %}</a>
                {% endif %}
                {% with categorization_review_form as review_form %}
                    {% include 'submissions/review_form.inc' %}
                {% endwith %}
            {% endblock %}
        </div>
    {% endif %}
    {% for checklist, checklist_review_form in checklist_reviews %}
    <div id="checklist_{{ checklist.pk }}_review_form" class="checklist_review_tab">
        {% with checklist_review_form as review_form %}
            {% include 'submissions/review_form.inc' %}
        {% endwith %}
    </div>
    {% endfor %}
    
    <div id="communication_tab" class="tab">
        <div class="widget" widgeturl="{% url ecs.communication.views.incoming_message_widget %}?submission={{ submission_form.submission.pk }}"></div>
        <div class="widget" widgeturl="{% url ecs.communication.views.outgoing_message_widget %}?submission={{ submission_form.submission.pk }}"></div>
        <a href="{% url ecs.communication.views.new_thread submission_pk=submission_form.submission.pk %}" class="button_submit">{% trans "Write a new message" %}</a>
    </div>
    {% if user|has_flag:'internal' %}
        <div id="communication_overview_tab" class="tab">
            <div class="widget" widgeturl="{% url ecs.communication.views.communication_overview_widget submission_pk=submission_form.submission.pk %}"></div>
        </div>
    {% endif %}
    {% if user.get_profile.has_explicit_workflow %}
        <div id="workflow_tab" class="tab">
            <div class="widget" widgeturl="{% url ecs.tasks.views.my_tasks %}?submission={{ submission_form.submission.pk }}"></div>
        </div>
        {% if user|has_flag:'internal' %}
            <div id="workflow_log" class="tab">
                <div class="widget" widgeturl="{% url ecs.tasks.views.task_backlog submission_pk=submission_form.submission.pk %}"></div>
            </div>
        {% endif %}
    {% endif %}
    {{ block.super }}
{% endblock %}

{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript"> 
        window.addEvent('domready', function(){
            $$('*[widgeturl]').each(function(w){
                var widgeturl = w.getAttribute('widgeturl');
                new ecs.widgets.Widget(w, {url: widgeturl});
            }, this);

            new ecs.FormFieldController(['id_external_reviewer'], {
                sources: ['id_thesis', 'id_expedited'], 
                auto: function(values){
                    var no_external_reviewer = values.some(function(val){ return val == 2;});
                    this.setDisabled(no_external_reviewer);
                    if(no_external_reviewer) {
                        this.setValues([3, ""]);
                    }
                }
            });

            new ecs.FormFieldController(['id_external_reviewer_name'], {
                sources: ['id_external_reviewer'],
                auto: function(values){
                    this.setDisabled(values[0] == 3); /* no external reviewer required */
                }
            });
            
            var reviewToolbarItems = [
                ecs.textarea.toolbarItems.annotations("{% trans 'Insert Annotations' %}", '{% url ecs.pdfviewer.views.copy_annotations %}?submission_form_pk={{ submission_form.pk }}')
            ];
            {% if user|has_flag:'internal' %}
                reviewToolbarItems.push(ecs.textarea.toolbarItems.boilerplate("{% trans 'Insert Boilerplate' %}", "{% url ecs.boilerplate.views.select_boilerplate %}"));
            {% endif %}
            
            $$('form.review .CharField textarea').each(function(textarea){
                ecs.textarea.installToolbar(textarea, reviewToolbarItems);
            });

            var review_save_buttons = $$('.header_actions')[0].getElements('a.review[id^=save_]');
            review_save_buttons.each(function(el){
                var tab_name = el.id.substring('save_'.length);
                el.addEvent('click', function(){
                    $(tab_name).getElement('input[type="submit"][name="save"]').click();
                    return false;
                });
            }, this);

            var review_close_buttons = $$('.header_actions')[0].getElements('a.review[id^=close_]');
            review_close_buttons.each(function(el){
                var tab_name = el.id.substring('close_'.length);
                el.addEvent('click', function(){
                    $(tab_name).getElement('input[type="submit"][name="complete_task"]').click();
                    return false;
                });
            }, this);

            {% if review_incomplete %}
                new MooDialog.Error('{% trans "Your review is incomplete." %}');
            {% endif %}
            {% if review_complete %}
                new MooDialog.Confirm('{{ _("Do you want to close the review?")|escapejs }}', function(){
                    $('checklist_{{ review_complete }}_review_form').getElement('input[type="submit"][name="really_complete_task"]').click();
                }, null, {
                    okText: '{{ _("Close")|escapejs }}',
                    cancelText: '{{ _("Don't Close")|escapejs }}'
                })
            {% endif %}
        });
    </script>
{% endblock %}
