{% extends "submissions/base_form.html" %}
{% load core i18n userutils %} 


{% block htmltitle %}â€¦ | {{ submission_form.submission|ec_number }} | {{ block.super }}{% endblock %}

{% block headertitle %}
    <a href="{% url 'readonly_submission_form' submission_form_pk=submission_form.pk %}" target="_blank"><span class="preview_icon"></span> {{ submission_form.submission|ec_number }}</a> 
    {{ submission.project_title_display|default:'<em>Ohne Titel</em>' }}
    {% if submission.is_finished %}
        ({% trans 'finished' %})
    {% endif %}
{% endblock %}


{% block header_actions %}
    {{ block.super }}
    <div class="header_actions">
        {% if submission_form|allows_edits_by:request.user %}
            <a href="{% url 'ecs.core.views.submissions.copy_latest_submission_form' submission_pk=submission.pk %}">{% trans 'Edit' %}</a>
        {% endif %}
        {% if submission_form|allows_amendments_by:request.user %}
            {% for notification_type in diff_notification_types %}
                <a href="{% url 'ecs.core.views.submissions.copy_latest_submission_form' submission_pk=submission.pk notification_type_pk=notification_type.pk %}">{{ notification_type.name }}</a>
            {% endfor %}
        {% endif %}
        
        {% if not request.task_management.form %}
            {% if not open_checklist %}
                {% with submission.external_review_task as external_review_task %}
                    {% if external_review_task %}
                        <a href="{{ external_review_task.url }}">{% trans 'Start External Review' %}</a>
                    {% endif %}
                {% endwith %}
            {% endif %}
            {% for checklist, checklist_review_form in checklist_reviews %}
                {% if not checklist_review_form.readonly %}
                    {% if checklist_review_form.related_task %}
                        <a class="review button_save" id="save_checklist_{{ checklist.pk }}_review_form" href="">{% blocktrans with checklist_review_form.related_task.task_type as review %}save {{ review }}{% endblocktrans %}</a>
                        <a class="review button_submit" id="close_checklist_{{ checklist.pk }}_review_form" href="">{% blocktrans with checklist_review_form.related_task.task_type as review %}complete {{ review }}{% endblocktrans %}</a>
                    {% else %}
                        <a class="review button_save" id="save_checklist_{{ checklist.pk }}_review_form" href="">{% blocktrans with checklist.blueprint.name as review %}save {{ review }}{% endblocktrans %}</a>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}


{% block headernav %}
  <div class="readonly">
    <div class="tab_header_groups">
    {% block tab_header_groups %}
        <a href="#tabs_general">{% trans "General" %}</a>
        {{ block.super }}
        {% if categorization_review_form or checklist_reviews or user|has_flag:'is_internal' %}
            <a href="#tabs_checklists">{% trans "Evaluations" %}</a>
        {% endif %}
        <a href="#tabs_votes">{% trans "Votes" %}</a>
        <a href="#tabs_notifications">{% trans "Notifications" %}</a>
        <a href="#tabs_communication">{% trans "Communication" %}</a>
    {% endblock %}
    </div>

    {% block tab_headers %}
        <div id="tabs_general" class="tab_headers collapse">
            <a href="#status_tab">{% trans 'Status' %}</a>
            {% if user.profile.has_explicit_workflow %}
                <a href="#workflow_tab">{% trans 'Workflow' %}</a>
                {% if user|has_flag:'is_internal' %}
                    <a href="#workflow_log">{% trans 'Workflow Log' %}</a>
                {% endif %}
            {% endif %}
            {% if not user|is_presenting_party:submission_form %}
                <a href="#involved_parties_tab">{% trans 'Involved Parties' %}</a>
            {% endif %}
        </div>

        {{ block.super }}

        {% if categorization_review_form or checklist_reviews or user|has_flag:'is_internal' %}
        <div id="tabs_checklists" class="tab_headers collapse">
            {% if user|has_flag:'is_internal' %}
                <a href="#checklist_summary_tab">{% trans "Checklist Summary" %}</a>
            {% endif %}
            {% if categorization_review_form %}
            <a href="#categorization_review_tab"{% if not categorization_review_form.readonly %} class="readonly_review active"{% endif %}>{% trans "Categorization Review" %}</a>
            {% endif %}
            {% for checklist, checklist_review_form in checklist_reviews %}
                <a href="#checklist_{{ checklist.pk }}_review_form"{% if not checklist_review_form.readonly %} class="readonly_review active"{% endif %}{% if active_checklist == checklist.pk %} class="active"{% endif %}>{{ checklist.short_name }}</a>
            {% endfor %}
        </div>
        {% endif %}

        <div id="tabs_votes" class="tab_headers collapse">
            {% if vote_review_form %}
                <a href="#vote_review_tab"{% if not vote_review_form.readonly %} class="readonly_review active"{% endif %}>Votum</a>
            {% endif %}
            <a href="#published_votes_tab">{% trans "Published Votes" %}</a>
        </div>

        <div id="tabs_notifications" class="tab_headers collapse">
            <a href="#pending_notifications_tab">{% trans "Pending Notifications" %}</a>
            <a href="#answered_notifications_tab">{% trans "Answered Notifications" %}</a>
        </div>

        <div id="tabs_communication" class="tab_headers collapse">
            <a href="#communication_tab">{% trans "My Communication" %}</a>
            {% if user|has_flag:'is_internal' %}
                <a href="#communication_overview_tab">{% trans "Communication Overview" %}</a>
            {% endif %}
        </div>
    {% endblock %}
  </div>
{% endblock %}

{% block content %}
    <div class="readonly">
        {{ block.super }}
    </div>
{% endblock %}

{% block tabs %}
    <div id="status_tab" class="collapse">
        {% include 'submissions/tabs/status.html' %}
    </div>
    {% if not user|is_presenting_party:submission_form %}
        <div id="involved_parties_tab" class="collapse">
            {% include 'submissions/tabs/involved_parties.html' %}
        </div>
    {% endif %}
    <div id="pending_notifications_tab" class="tab collapse">
        <h3>{% trans "Open Notifications" %}</h3>
        {% if open_notifications %}
            <ol class="notification_list">
                {% for notification in open_notifications %}
                    <li>
                        <a href="{% url 'ecs.notifications.views.view_notification' notification_pk=notification.pk %}">{{ notification }}</a>
                        von {{ notification.user }} am {{ notification.timestamp|date:'d.m.Y' }}
                    </li>
                {% endfor %}
            </ol>
        {% else %}
            <p>{% trans "There are no open notifications." %}</p>
        {% endif %}
        {% if stashed_notifications %}
            <h3>Nicht eingereichte Meldungen</h3>
            {% include 'notifications/stashed_notification_list.html' %}
        {% endif %}
        {% if submission.presenter == request.user or submission.susar_presenter == request.user %}
            <a href="{% url 'ecs.notifications.views.select_notification_creation_type' %}" class="button_submit">{% trans "Create a new notification" %}</a>
        {% endif %}
    </div>
    <div id="answered_notifications_tab" class="tab collapse">
        <h3>{% trans "Answered Notifications" %}</h3>
        {% if answered_notifications %}
            <ol class="notification_list">
                {% for notification in answered_notifications %}
                    <li{% if notification.is_rejected %} class="rejected"{% endif %}>
                        <a href="{% url 'ecs.notifications.views.view_notification' notification_pk=notification.pk %}">{{ notification }}</a>
                        von {{ notification.user }} am {{ notification.timestamp|date:'d.m.Y' }}
                        {% if notification.is_rejected %}({% trans 'rejected' %}){% endif %}
                        {% if user|has_flag:'is_internal' %}
                        | <a href="javascript:void(ecs.fieldhistory.show('{% url 'ecs.core.views.fieldhistory.field_history' model_name='notification_answer' pk=notification.answer.pk %}', 'text'))">{% trans 'History' %}</a>
                        {% endif %}
                    </li>
                {% endfor %}
            </ol>
        {% else %}
            <p>{% trans "There are no answered notifications." %}</p>
        {% endif %}
        {% if submission.presenter == request.user %}
            <a href="{% url 'ecs.notifications.views.select_notification_creation_type' %}" class="button_submit">{% trans "Create a new notification" %}</a>
        {% endif %}
    </div>
    {% if vote_review_form %}
        <div id="vote_review_tab" class="tab collapse">
            {% block vote_review_tab_content %}
                <h3>B{{ vote.result }} Votum{% if vote.top %} der Sitzung {{ vote.top.meeting.title }} am {{ vote.top.meeting.start|date:'d.m.Y' }}{% endif %}{% if vote.changed_after_voting %} <span style="color:red;">!!{% trans 'Changed after voting' %}!!</span>{% endif %}</h3>
                <form action="" method="post" class="review vote{% if vote_review_form.bound_to_task %} bound_to_task{% endif %}">
                    {% csrf_token %}
                    {% with vote_review_form as review_form %}
                        {% if review_form.is_preparation %}
                            {% include 'submissions/review_form.inc' %}
                        {% else %}
                            {% include 'submissions/vote_review_form.inc' %}
                        {% endif %}
                    {% endwith %}
                </form>
            {% endblock %}
        </div>
    {% endif %}

    <div id="published_votes_tab" class="tab collapse">
        <h3>{% trans "Published Votes" %}</h3>
        {% if published_votes %}
            <ul>
                {% for vote in published_votes %}
                    <li>{{ vote.result_text }}{% if vote.top %} (in der Sitzung am {{ vote.top.meeting.start|date:'d.m.Y' }}){% endif %}
                    {% if vote.valid_until %} {% trans 'valid until' %} {{ vote.valid_until|date:'d.m.Y' }}{% endif %}
                    <a href="{% url 'ecs.votes.views.download_signed_vote' vote_pk=vote.pk %}">{% trans "Download" %}</a>
                    {% if user|has_flag:'is_internal' %}
                        | <a href="javascript:void(ecs.fieldhistory.show('{% url 'ecs.core.views.fieldhistory.field_history' model_name='vote' pk=vote.pk %}', 'text'))">{% trans 'History' %}</a>
                    {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>{% trans "There are no published votes." %}</p>
        {% endif %}
    </div>

    {% if user|has_flag:'is_internal' %}
        <div id="checklist_summary_tab" class="tab collapse">
            {% include 'submissions/checklist_summary.inc' %}
        </div>
    {% endif %}

    {% if categorization_review_form %}
        <div id="categorization_review_tab" class="tab collapse">
            {% block categorization_review_tab_content %}
                {% if categorization_task and categorization_review_form.readonly and submission.allows_categorization %}
                    <p><a href="{% url 'ecs.tasks.views.reopen_task' task_pk=categorization_task.pk %}" class="button_submit">{% trans 'Reopen' %}</a></p>
                {% endif %}
                <p>
                    Typ:
                    {% if submission_form.is_amg %}
                        {% trans "AMG" %}(ECT:{{submission_form.eudract_number }}, {{ submission_form.get_submission_type_display }})
                    {% endif %}
                    {% if submission_form.is_mpg %}{% trans "MPG" %}{% endif %}
                    {% if submission_form.is_thesis %}{{ submission_form.get_project_type_education_context_display }}{% endif %}
                    {% if submission_form.includes_minors %}{% trans "minors" %}{% endif %}
                </p>
                {% with categorization_review_form as review_form %}
                    {% include 'submissions/review_form.inc' %}
                {% endwith %}
            {% endblock %}
        </div>
    {% endif %}
    {% for checklist, checklist_review_form in checklist_reviews %}
    <div id="checklist_{{ checklist.pk }}_review_form" class="checklist_review_tab collapse">
        {% if checklist_review_form.reopen_task and checklist_review_form.readonly %}
            <p><a href="{% url 'ecs.tasks.views.reopen_task' task_pk=checklist_review_form.reopen_task.pk %}" class="button_submit">{% trans 'Reopen' %}</a></p>
        {% endif %}
        {% with checklist_review_form as review_form %}
            {% if review_form.readonly and checklist.blueprint.allow_pdf_download and checklist.pdf_document and not checklist.status == 'new'%}
                {% if checklist.status == 'review_ok' or user|has_flag:'is_internal' %}
                    <p>
                        <a class="button_submit" href="{% url 'ecs.checklists.views.checklist_pdf' checklist_pk=checklist.pk %}">
                            <span class="icon_pdf" style="vertical-align: middle;"></span>
                            <span>{% if checklist.status == 'review_ok' %}{% trans "Download PDF" %}{% else %}{% trans 'Download unpublished Version as PDF' %}{% endif %}<span>
                        </a>
                    </p>
                {% endif %}
            {% endif %}
            {% include 'submissions/checklist_review_form.inc' %}
        {% endwith %}
    </div>
    {% endfor %}
    
    <div id="communication_tab" class="tab collapse">
        <div data-widget-url="{% url 'ecs.communication.views.incoming_message_widget' submission_pk=submission.pk %}"></div>
        <div data-widget-url="{% url 'ecs.communication.views.outgoing_message_widget' submission_pk=submission.pk %}"></div>
        <a href="{% url 'ecs.communication.views.new_thread' submission_pk=submission.pk %}" target="_blank" class="button_submit">{% trans "Write a new message" %}</a>
    </div>
    {% if user|has_flag:'is_internal' %}
        <div id="communication_overview_tab" class="tab collapse">
            <div data-widget-url="{% url 'ecs.communication.views.communication_overview_widget' submission_pk=submission.pk %}"></div>
        </div>
    {% endif %}
    {% if user.profile.has_explicit_workflow %}
        <div id="workflow_tab" class="tab collapse">
            <div data-widget-url="{% url 'ecs.tasks.views.my_tasks' submission_pk=submission.pk %}"></div>
        </div>
        {% if user|has_flag:'is_internal' %}
            <div id="workflow_log" class="tab collapse">
                <div data-widget-url="{% url 'ecs.tasks.views.task_backlog' submission_pk=submission.pk %}"></div>
            </div>
        {% endif %}
    {% endif %}
    {{ block.super }}
{% endblock %}

{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript"> 
        jQuery(function(){
            ecs.setupForms();
            ecs.setupWidgets();

            jQuery('form.review .CharField textarea').each(function(){
                ecs.textarea.installToolbar(this, [
                    {% if user|has_flag:'is_internal' %}
                        ecs.textarea.toolbarItems.boilerplate(
                            "{% trans 'Insert Boilerplate' %}",
                            "{% url 'ecs.boilerplate.views.select_boilerplate' %}"
                        )
                    {% endif %}
                ]);
            });
            
            {% if user|has_flag:'is_internal' and vote_review_form and vote %}
                jQuery('form.review.vote .CharField textarea').each(function(){
                    ecs.textarea.installToolbarItem(this,
                        ecs.textarea.toolbarItems.versionHistory(
                            "{% trans 'History' %} ({{ vote_version }})",
                            "{% url 'ecs.core.views.fieldhistory.field_history' model_name='vote' pk=vote.pk %}"
                        )
                    );
                });
            {% endif %}


            jQuery('.header_actions a.review[id^=save_]').click(function(ev) {
                ev.preventDefault();
                var tab = jQuery(this).attr('id').substring('save_'.length);
                jQuery('#' + tab).find('input[type="submit"][name="save"]').click();
            });

            jQuery('.header_actions a.review[id^=close_]').click(function(ev) {
                ev.preventDefault();
                var tab = jQuery(this).attr('id').substring('close_'.length);
                jQuery('#' + tab).find('input[type="submit"][name="complete_task"]').click();
            });

            {% if review_complete %}
                ecs.confirm({
                    question: '{{ _("Do you want to close the review and send it to the EC?")|escapejs }}',
                    ok: '{{ _("Yes")|escapejs }}',
                    cancel: '{{ _("No")|escapejs }}',
                    success: function() {
                        jQuery('#checklist_{{ review_complete }}_review_form')
                            .find('input[type="submit"][name="really_complete_task"]')
                            .click();
                    }
                })
            {% endif %}

            if (!jQuery('#id_invoice_differs_from_sponsor').is(':checked'))
                jQuery('#tabs-4 .fieldset_2').hide();

            jQuery('#tabs_submission a').each(function() {
                var container = jQuery(jQuery(this).attr('href'));
                container.find('input[type="checkbox"]').each(function() {
                    var input = jQuery(this);
                    if (!input.is(':checked'))
                        input.parent('li.BooleanField').hide();
                });
            });
        });
    </script>
{% endblock %}
