{% extends "submissions/base_form.html" %}
{% load core i18n %} 

{% block workflow_query_params %}submission={{ submission_form.submission_id }}{% endblock %}

{% block headertext %}
  {{ submission_form.submission.ec_number }} {{ submission_form.project_title }}
{% endblock %}

{% block header_actions %}
    {{ block.super }}
    <div class="floating_box">
        <a href="{% url ecs.core.views.copy_submission_form submission_form_pk=submission_form.pk %}">Bearbeiten</a>
    </div>
{% endblock %}


{% block headernav %}
  <div class="readonly">
    <ul class="tab_header_groups">
    {% block tab_header_groups %}
        <li>
            <a href="#">{% trans "Status" %}</a>
            <ul class="tab_headers">
                <li>
                    <a href="#status_tab">Status</a>
                </li>
                <li>
                    <a href="#workflow_tab">Workflow</a>
                </li>
            </ul>
        </li>

        {{ block.super }}

        <li>
            <a href="#">{% trans "Review" %}</a>
            <ul class="tab_headers">
                <li{% if not executive_review_form.readonly %} class="readonly_review active"{% endif %}>
                    <a href="#executive_review_tab">Executive Review</a>
                </li>
                <li{% if not retrospective_thesis_review_form.readonly %} class="readonly_review active"{% endif %}>
                    <a href="#retrospective_thesis_review_tab">Thesis Review</a>
                </li>
                {% if b2_vote_review_form %}
                    <li class="active">
                        <a href="#b2vote_review_tab">B2 Votum</a>
                    </li>
                {% else %}
                    <li{% if not vote_review_form.readonly %} class="readonly_review active"{% endif %}>
                        <a href="#vote_review_tab">Votum</a>
                    </li>
                {% endif %}
                {% for blueprint, checklist_review_form in checklist_reviews %}
                    <li{% if not checklist_review_form.readonly %} class="readonly_review active"{% endif %}>
                        <a href="#checklist_{{ blueprint.pk }}_review_form">{{ blueprint.name }}</a>
                    </li>
                {% endfor %}
                <li{% if not befangene_review_form.readonly %} class="readonly_review active"{% endif %}>
                    <a href="#befangene_review_tab">Befangene Review</a>
                </li>
            </ul>
        </li>
        <li>
            <a href="#">{% trans "Communication" %}</a>
            <ul class="tab_headers">
                <li><a href="#communication_tab">{% trans "My Communication" %}</a></li>
                <li><a href="#communication_overview_tab">{% trans "Communication Overview" %}</a></li>
            </ul>
        </li>
        <li>
            <a href="#">{% trans "Votes" %}</a>
            <ul class="tab_headers">
                <li><a href="#pending_votes_tab">{% trans "Pending Votes" %}</a></li>
                <li><a href="#published_votes_tab">{% trans "Published Votes" %}</a></li>
            </ul>
        </li>
        <li>
            <a href="#">{% trans "Notifications" %}</a>
            <ul class="tab_headers">
                <li><a href="#pending_notifications_tab">{% trans "Pending Notifications" %}</a></li>
                <li><a href="#answered_notifications_tab">{% trans "Answered Notifications" %}</a></li>
            </ul>
        </li>
    {% endblock %}
    </ul>
  </div>
{% endblock %}

{% block content %}
    <div class="readonly">
        {{ block.super }}
    </div>
{% endblock %}

{% block tabs %}
    <div id="status_tab">
        <h3>Status</h3>
        <table>
            <tr><th>Eingereicht am:</th><td>?</td></tr>
            <tr><th>Eingereicht von:</th><td>?</td></tr>
            <tr><th>Akzeptiert:</th><td>?</td></tr>
            <tr><th>Monozentrisch:</th><td>{{ submission_form.monocentric|yesno }}</td></tr>
            <tr><th>Multizentrisch:</th><td>{{ submission_form.multicentric|yesno }}</td></tr>
            <tr><th>Aktiv:</th><td>{{ submission_form.submission.is_active|yesno }}</td></tr>
            <tr><th>Leitethikkommission:</th><td>{{ submission_form.main_ethics_commission|default:'<i>Keine Angabe</i>' }}</td></tr>
            <tr><th>Sitzungen:</th><td>
                <ul>
                    {% for meeting in submission_form.submission.meetings.all %}
                        <li><a href="{% url ecs.meetings.views.timetable_editor meeting_pk=meeting.pk %}">{{ meeting.start|date:'d.m.Y' }} {{ meeting.title }}</a></li>
                    {% endfor %}
                </ul>
            </td></tr>
            <tr><th>Voten:</th><td>
                <ul>
                    {% for vote in submission_form.submission.votes.all %}
                        <li>{{ vote.result }}{% if vote.top %} (in der Sitzung am {{ vote.top.meeting.start|date:'d.m.Y' }}){% endif %}</li>
                    {% endfor %}
                </ul>
            </td></tr>
            <tr><th>Kategorien:</th><td>
                {% for cat in submission_form.submission.medical_categories.all %}
                    {{ cat }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </td></tr>
            <tr><th>Exedited Review:</th><td>{{ submission_form.submission.expedited|yesno }}</td></tr>
            <tr><th>Dokumente:</th><td>
                {% include 'documents/compact_list.html' %}
            </td></tr>
        </table>
    </div>
    <div id="pending_notifications_tab" class="tab">
        <h3>{% trans "Pending Notifications" %}
        {% if pending_notifications %}
            <ul>
                {% for notification in pending_notifications %}
                    <li><a href="{% url ecs.core.views.view_notification notification_pk=notification.pk %}">{{ notification }}</a></li>
                {% endfor %}
            </ul>
        {% else %}
            <p>{% trans "There are no pending notifications." %}</p>
        {% endif %}
        <a href="{% url ecs.core.views.select_notification_creation_type %}">{% trans "Create a new notification" %}</a>
    </div>
    <div id="answered_notifications_tab" class="tab">
        <h3>{% trans "Answered Notifications" %}
        {% if answered_notifications %}
            <ul>
                {% for notification in answered_notifications %}
                    <li><a href="{% url ecs.core.views.view_notification notification_pk=notification.pk %}">{{ notification }}</a></li>
                {% endfor %}
            </ul>
        {% else %}
            <p>{% trans "There are no answered notifications." %}</p>
        {% endif %}
        <a href="{% url ecs.core.views.select_notification_creation_type %}">{% trans "Create a new notification" %}</a>
    </div>
    <div id="pending_votes_tab" class="tab">
        <h3>{% trans "Pending Votes" %}</h3>
        {% if pending_votes %}
            <ul>
                {% for vote in pending_votes %}
                    <li>{{ vote.result }}{% if vote.top %} (in der Sitzung am {{ vote.top.meeting.start|date:'d.m.Y' }}){% endif %}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>{% trans "There are no pending votes." %}</p>
        {% endif %}
    </div>
    <div id="published_votes_tab" class="tab">
        <h3>{% trans "Published Votes" %}</h3>
        {% if published_votes %}
            <ul>
                {% for vote in published_votes %}
                    <li>{{ vote.result }}{% if vote.top %} (in der Sitzung am {{ vote.top.meeting.start|date:'d.m.Y' }}){% endif %}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>{% trans "There are no published votes." %}</p>
        {% endif %}
    </div>
    <div id="executive_review_tab" class="tab">
        {% block executive_review_tab_content %}
            {% with executive_review_form as review_form %}
                {% include 'submissions/review_form.inc' %}
            {% endwith %}
        {% endblock %}
    </div>
    <div id="retrospective_thesis_review_tab" class="tab">
        {% block retrospective_thesis_review_tab_content %}
            {% with retrospective_thesis_review_form as review_form %}
                {% include 'submissions/review_form.inc' %}
            {% endwith %}
        {% endblock %}
    </div>
    {% if b2_vote_review_form %}
        <div id="b2vote_review_tab" class="tab">
            <h3>B2 Votum der Sitzung {{ vote.top.meeting.title }} am {{ vote.top.meeting.start|date:'d.m.Y' }} ({{ vote.top }})</h3>
            <h4>Upgrade auf B1</h4>
            {% with b2_vote_review_form as review_form %}
                {% include 'submissions/review_form.inc' %}
            {% endwith %}
        </div>
    {% else %}
        <div id="vote_review_tab" class="tab">
            {% block vote_review_tab_content %}
                <h3>Votum der Sitzung {{ vote.top.meeting.title }} am {{ vote.top.meeting.start|date:'d.m.Y' }} ({{ vote.top }})</h3>
                {% with vote_review_form as review_form %}
                    {% include 'submissions/review_form.inc' %}
                {% endwith %}
            {% endblock %}
        </div>
    {% endif %}
    {% for blueprint, checklist_review_form in checklist_reviews %}
    <div id="checklist_{{ blueprint.pk }}_review_form" class="checklist_review_tab">
        {% with checklist_review_form as review_form %}
            {% include 'submissions/review_form.inc' %}
        {% endwith %}
    </div>
    {% endfor %}
    <div id="befangene_review_tab" class="tab">
        {% block befangene_review_tab_content %}
            {% with befangene_review_form as review_form %}
                {% include 'submissions/review_form.inc' %}
            {% endwith %}
        {% endblock %}
    </div>
    <div id="communication_tab" class="tab">
        <h3>{% trans "My Communication" %}</h3>
        <div id="incoming_messages"></div>
        <div id="outgoing_messages"></div>
        <a href="{% url ecs.messages.views.send_message submission_pk=submission_form.submission.pk %}">{% trans "Write a new message" %}</a>
    </div>
    <div id="communication_overview_tab" class="tab">
        <h3>{% trans "Communication Overview" %}</h3>
        <div id="communication_overview_messages"></div>
    </div>
    <div id="workflow_tab" class="tab">
        <h3>Workflow</h3>
    </div>
    {{ block.super }}
{% endblock %}

{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript"> 
        window.addEvent('domready', function(){
            [
                'id_project_type_misc', 
                'id_pharma_checked_substance', 
                'id_pharma_reference_substance', 
                'id_substance_p_c_t_period',
                'id_medtech_checked_product',
                'id_medtech_reference_substance',
                'id_medtech_technical_safety_regulations',
                'id_medtech_departure_from_regulations',
                'id_additional_therapy_info',
        
            ].each(function(id){
                ecs.setupRichTextEditor($(id), true);
            });
            
            var updateChecklistCommentVisibility = function(select){
                $(select.id.replace(/q/, 'c')).getParent('li').setClass('checklist_field_hidden', select.value != 3);
            };
            
            $$('.checklist_review_tab').each(function(tabBody){
                tabBody.getElements('.NullBooleanField>select').each(function(select){
                    select.addEvent('change', updateChecklistCommentVisibility.bind(window, select));
                });
            });
            
            var msgRequest = new Request.HTML({
                url: '{% url ecs.messages.views.incoming_message_widget %}?submission={{ submission_form.submission.pk }}',
                update: $('incoming_messages')
            });
            msgRequest.send();
            
            var msgRequest = new Request.HTML({
                url: '{% url ecs.messages.views.outgoing_message_widget %}?submission={{ submission_form.submission.pk }}',
                update: $('outgoing_messages')
            });
            msgRequest.send();

            var msgRequest = new Request.HTML({
                url: '{% url ecs.messages.views.communication_overview_widget submission_pk=submission_form.submission.pk %}',
                update: $('communication_overview_messages')
            });
            msgRequest.send();

        });
    </script>
{% endblock %}
