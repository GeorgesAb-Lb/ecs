{% extends 'meetings/assistant/base.html' %}
{% load core i18n userutils %}

{% block meeting_assistant_body %}
  <div class="column_main">
    <form id="meeting_assistant_form" action="{% url ecs.meetings.views.meeting_assistant_top meeting_pk=meeting.pk top_pk=top.pk %}" method="post" class="open-in-widget">
        <h3>{{ top }}, {{ submission|ec_number|default:top.title }}{% if submission %} {% with top|last_recessed_vote as vote %}{% if vote %}({% trans "Recessed" %}, {% if vote.result == '3a' %}{% trans "not examined" %}{% else %}{% trans "examined" %}{% endif %}) {% endif %}{% endwith %}<a class="preview" href="{% url view_submission submission_pk=submission.pk %}" target="_blank">preview</a>{% endif %}</h3>
        {% if not top.is_break %}
            {{ submission.project_title_display|default:top.title }}<br />
            {% trans "Submitter" %}: {{ submission.current_submission_form.submitter }} ({{ submission.current_submission_form.submitter_organisation }})
        {% endif %}
        <span class="meta">
            Geplante Startzeit: {{ top.start|date:'H:i:s' }} Uhr, Geplante Dauer: {{ top.duration|simple_timedelta_format }}
        </span>
    {% if not submission %}
        <div class="meeting_assistant_block">
            <div class="block_left">
                {% if top.is_break %}
                    <div style="font-size:80px;color:#cc0000;position:relative">PAUSE<div style="font-size:80px;color:#ff6600;position:absolute;left:-3px;top:-3px">PAUSE</div></div>
                {% endif %}
            </div>
            <div class="block_right">
                <div class="buttons">
                  <ul>
                      <li><a id="complete" href="">Fertig</a></li>
                  </ul>
                </div>
            </div>
        </div>
    {% else %}
        <input id="id_executive_review_required" type="hidden" name="executive_review_required" value="" />
        <input id="id_close_top" type="hidden" name="close_top" value="1" />
        <input id="id_simple_save" type="hidden" name="simple_save" value="" />
          <h3>Votum</h3>
            <div class="meeting_assistant_block">
                          
              <div class="block_left">
                  {% if form.result.errors %}
                      <span class="errors">{{ form.result.errors }}</span>
                  {% endif %}
                  {{ form.result }}
              </div>
  
              <div class="block_right">
      
                <div class="buttons">
                   <ul>
                      <li><a id="complete_executive" href=""{% if vote and not top.is_open and form|form_value:'executive_review_required' %} class="selected"{% endif %}>Fertig<span class="details">Executive Review</span></a></li>
                      <li><a id="complete_office" href=""{% if vote and not top.is_open and not form|form_value:'executive_review_required' %} class="selected"{% endif %}>Fertig<span class="details">Office Review</span></a></li>
                      <li><a id="save" href="">Nur Speichern<span class="details">Nicht abgeschlossen</span></a></li>
                   </ul>
                </div>
              </div>
              
            </div>
            
            {{ form.text }}
            
    {% endif %}

    </form>
            
  </div>
{% endblock %}

{% block meeting_assistant_navigation %}
    {% if top.next_open %}
        <a class="open-in-widget" href="{% url ecs.meetings.views.meeting_assistant_top meeting_pk=meeting.pk,top_pk=top.next_open.pk %}">Nächstes offenes TOP ({{ top.next_open }})</a>
    {% endif %}
    {% if top.previous_open %}
        <a class="open-in-widget" href="{% url ecs.meetings.views.meeting_assistant_top meeting_pk=meeting.pk,top_pk=top.previous_open.pk %}">Vorheriges offenes TOP ({{ top.previous_open }})</a>
    {% endif %}
    {% if top.next %}
        <a class="open-in-widget" href="{% url ecs.meetings.views.meeting_assistant_top meeting_pk=meeting.pk,top_pk=top.next.pk %}">Nächstes TOP ({{ top.next }})</a>
    {% endif %}
    {% if top.previous %}
        <a class="open-in-widget" href="{% url ecs.meetings.views.meeting_assistant_top meeting_pk=meeting.pk,top_pk=top.previous.pk %}">Vorheriges TOP ({{ top.previous }})</a>
    {% endif %}
    {% if last_top %}
        <a class="open-in-widget" href="{% url ecs.meetings.views.meeting_assistant_top meeting_pk=meeting.pk,top_pk=last_top.pk %}">Letztbesprochenes TOP ({{ last_top }})</a>
    {% endif %}
    {{ block.super }}
{% endblock %}

{% block meeting_assistant_sidebar %}
      <div class="column">
        <div class="reviews">
          <ul>
          {% for blueprint, checklists in checklist_review_states %}
            {% for task, checklist in checklists %}
              <li class="{% if checklist and task.closed_at %}{{ checklist.is_positive|yesno:'positive,negative' }} {{ checklist.is_complete|yesno:'complete,incomplete' }}{% else %}negative incomplete{% endif %}">
                {{ task.task_type }}
                {% if task.assigned_to %}
                  ({{ task.assigned_to }})
                {% endif %}
                {% if checklist and task.closed_at %}
                  {% if checklist.has_positive_comments %}
                    <a class="textblock" href="{% url ecs.checklists.views.checklist_comments flavour='positive',checklist_pk=checklist.pk %}">{% trans 'copy positive' %}</a>
                  {% endif %}
                  {% if checklist.has_negative_comments %}
                    <a class="textblock" href="{% url ecs.checklists.views.checklist_comments flavour='negative',checklist_pk=checklist.pk %}">{% trans 'copy negative' %}</a>
                  {% endif %}
                {% endif %}
              </li>
            {% endfor %}
          {% endfor %}


          {% if submission %}
              {% sudo %}
              {% with submission|paper_submission_review:user as task %}
              {% if task and not task.closed_at %}
                  <li class="negative complete">
                    {{ task.task_type }}
                    {% if task.assigned_to %}
                      ({{ task.assigned_to }})
                    {% endif %}
                  </li>
              {% endif %}
              {% endwith %}
              {% endsudo %}
          {% endif %}
          </ul>
        </div>
      </div>

    <script type="text/javascript">
        window.addEvent('domready', function(){
            /* ecs.setupForms(); */ /* do we need this? */
            {% if submission %}
            var textarea = $('id_text')
            new ecs.textarea.TextArea(textarea);
            ecs.textarea.installToolbar(textarea, [
                ecs.textarea.toolbarItems.boilerplate("{% trans 'Insert Boilerplate' %}", "{% url ecs.boilerplate.views.select_boilerplate %}")
            ]);
            {% endif %}
            
            var meetingAssistantForm = $('meeting_assistant_form');
            {% if not submission %}
                $('complete').addEvent('click', function(){
                    meetingAssistantForm.submit();
                    return false;
                });
            {% else %}
                $('complete_executive').addEvent('click', function(){
                    $('id_executive_review_required').value = '1';
                    meetingAssistantForm.submit();
                    return false;
                });
                $('complete_office').addEvent('click', function(){
                    $('id_executive_review_required').value = '0';
                    meetingAssistantForm.submit();
                    return false;
                });
                $('save').addEvent('click', function(){
                    $('id_close_top').value = '0';
                    $('id_simple_save').value = '1';
                    meetingAssistantForm.submit();
                    return false;
                });
            {% endif %}
            $$('a.textblock').each(function(link){
                link.addEvent('click', function(){
                    var request = new Request({
                        url: link.href,
                        onSuccess: function(responseText){
                            var textarea = $('id_text');
                            textarea.value += "\n\n" + responseText;
                            textarea.retrieve('ecs.textarea.TextArea').updateHeight();
                        }
                    });
                    request.send();
                    return false;
                });
            });
        });
    </script>
{% endblock %}
