{% load core i18n %}

<h2>{% trans 'Submissions' %}</h2>

{% if meeting.documents_zip %}
    <a class="btn btn-outline-primary" href="{% url 'ecs.meetings.views.download_zipped_documents' meeting_pk=meeting.pk %}">
        {% trans 'Download all documents for this meeting (zip)' %}
        <div class="text-muted">
            {% blocktrans trimmed with date=meeting.documents_zip.date|date:'d.m.Y' time=meeting.documents_zip.date|date:'H:i' %}
                Created on {{ date }} at {{ time }}
            {% endblocktrans %}
        </div>
    </a>
{% else %}
    <button class="btn btn-secondary" disabled>
        {% trans 'Download all documents for this meeting (zip)' %}
        <div class="text-danger">{% trans 'Not available yet!' %}</div>
    </button>
{% endif %}

<ul class="list-group mt-2">
{% for top in tops %}
    {% ifchanged top.timetable_index|is_none %}
        {% if top.timetable_index|is_none %}
            </ul>
            <h2 class="mt-2">Weitere TOPs</h2>
            <ul class="list-group">
        {% endif %}
    {% endifchanged %}
    <li class="list-group-item {% if meeting.started and not meeting.ended and active_top_pk == top.pk %}list-group-item-info{% endif %} {% if not top.is_open and not meeting.ended %}disabled{% endif %}">
        <strong>TOP {{ forloop.counter }}</strong>
        {% if top.submission %}
            <a class="fa fa-download text-primary" title="{% trans 'Download documents (zip)' %}" href="{% url 'ecs.meetings.views.download_zipped_documents' meeting_pk=meeting.pk submission_pk=top.submission.pk %}"></a>
            {% with top.submission.current_submission_form as sf %}
                {% if sf.is_amg or sf.is_mpg %}({% if sf.is_amg %}AMG{% endif %}{% if sf.is_amg and sf.is_mpg %}/{% endif %}{% if sf.is_mpg %}MPG{% endif %}){% endif %}
            {% endwith %}
            {{ top.submission|ec_number }} {{ top.submission.project_title_display }}

            {% if user.profile.is_omniscient_member %}
                {% with doc=top.submission.current_submission_form.pdf_document %}
                    <div class="row mt-1">
                        <strong class="col-md-3">{{ doc.doctype }}</strong>
                        <div class="col-md-9">
                            {% url 'ecs.meetings.views.download_document' meeting_pk=meeting.pk document_pk=doc.pk as download_url %}
                            {% url 'ecs.meetings.views.view_document' meeting_pk=meeting.pk document_pk=doc.pk as view_url %}
                            <a href="{{ view_url }}" target="_blank">
                                {{ doc.name }}
                            </a>
                            - <em>Version {{ doc.version }} vom {{ doc.date|date:'d.m.Y' }}</em>
                            {% if doc.doctype.is_downloadable or user.profile.is_internal %}
                                | <a href="{{ download_url }}">{% trans "Download" %}</a>
                            {% endif %}
                            <br>
                        </div>
                    </div>
                {% endwith %}

                {% regroup top.submission.current_submission_form.documents.all by doctype as documents %}
                {% for document in documents %}
                    <div class="row">
                        <strong class="col-md-3">{{ document.grouper }}</strong>
                        <div class="col-md-9">
                            {% for doc in document.list %}
                                {% url 'ecs.meetings.views.download_document' meeting_pk=meeting.pk document_pk=doc.pk as download_url %}
                                {% url 'ecs.meetings.views.view_document' meeting_pk=meeting.pk document_pk=doc.pk as view_url %}
                                <a href="{{ view_url }}" target="_blank">
                                    {{ doc.name }}
                                </a>
                                - <em>Version {{ doc.version }} vom {{ doc.date|date:'d.m.Y' }}</em>
                                {% if doc.doctype.is_downloadable or user.profile.is_internal %}
                                    | <a href="{{ download_url }}">{% trans "Download" %}</a>
                                {% endif %}
                                <br>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% else %}
            {{ top.title }}
        {% endif %}
    </li>
{% endfor %}
</ul>
