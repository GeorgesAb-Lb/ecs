{% extends 'core.html' %}
{% load core i18n notifications %}

{% block headernav %}
    <ul class="tab_header_groups">
        <li>
            <a href="#">{% trans "New Notification" %}</a>
            <ul class="tab_headers">
            {% for tab, fieldsets in tabs %}
                <li><a href="#tabs-{{ forloop.counter }}">{{ tab }}</a></li>
            {% endfor %}
            </ul>
        </li>
    </ul>
    {{ block.super }}
{% endblock %}

{% block htmltitle %}Neu: {{ notification_type.name }} | {{ block.super }}{% endblock %}
{% block headertitle %}Neu: {{ notification_type.name }}{% endblock %}

{% block header_actions %}
    {{ block.super }}
    <div class="header_actions">
      <a href="" id="save-button" class="button_save">{% trans "Save" %}</a>
      <a href="" id="submit-button" class="button_submit">{% trans "Submit" %}</a>
    </div>
{% endblock %}

{% block content %}
<div class="form_main notifications">
<form action="" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div id="tabs">
        {% for tab in tabs %}
            <div id="tabs-{{ forloop.counter }}" class="tab">
                {% if tab.slug == 'documents' %}
                    <div class="field">
                        <div class="upload_container"></div>
                    </div>
                {% endif %}
                
                {% if tab.slug == 'changes' %}
                    <div class="field">
                        {% if notification_type.includes_diff %}
                            <div class="diff_toggles">
                                <a href="#" id="diff_show_old">{% trans "old" %}</a>
                                <a href="#" id="diff_show_new">{% trans "new" %}</a>
                                <a href="#" id="diff_show_all">{% trans "all" %}</a>
                            </div>
                            <div class="diff">
                                {{ request.docstash|diff_from_docstash|safe }}
                            </div>
                        {% else %}
                            <em>{% trans 'No changes.' %}</em>
                        {% endif %}
                    </div>
                {% endif %}
                
                {% for legend, fields in tab.fieldsets %}
                    <div class="fieldset_{{ forloop.counter }}">
                        {% if legend %}
                            <h3>{{ legend }}</h3>
                        {% endif %}
                        <ol>
                            {% for field_name in fields %}
                                {% with form|getitem:field_name as field %}
                                    {% include "forms/field.html" %}
                                {% endwith %}
                            {% endfor %}
                        </ol>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
    <input type="submit" value="submit" name="submit" class="hidden" />
    <input type="submit" value="validate" name="validate" class="hidden" />
</form>
</div>
{% endblock %}

{% block menuSelection %}notifications{% endblock %}
{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript">
        jQuery(function(){
            ecs.setupForms();
            
            jQuery('#diff_show_old').click(function(ev) {
                ev.preventDefault();
                jQuery('.diff .deleted').show();
                jQuery('.diff .inserted').hide();
            });
            jQuery('#diff_show_new').click(function(ev) {
                ev.preventDefault();
                jQuery('.diff .deleted').hide();
                jQuery('.diff .inserted').show();
            });
            jQuery('#diff_show_all').click(function(ev) {
                ev.preventDefault();
                jQuery('.diff .deleted').show();
                jQuery('.diff .inserted').show();
            });

            jQuery('#save-button').click(function(ev){
                ev.preventDefault();
                ecs.mainForm.save(true);
            });
            jQuery('#submit-button').click(function(ev){
                ev.preventDefault();
                ecs.mainForm.submit('submit');
            });

            var submissionFormsSelect = $('id_submission_forms');
            var submissionFormSelect = $('id_submission_form');
            var submissionDataDisplay = new Element('div', {'class': 'submission_data'});
            if(submissionFormSelect || submissionFormsSelect){
                (submissionFormSelect || submissionFormsSelect).getParent('li').grab(submissionDataDisplay);
            }

            function loadSubmissionFormData(pks){
                var request = new Request.HTML({
                    url: '{% url 'ecs.notifications.views.submission_data_for_notification' %}',
                    data: 'submission_form=' + pks.join('&submission_form='),
                    method: 'get',
                    evalScripts: false,
                    update: submissionDataDisplay
                });
                request.send();
            }
            if(submissionFormsSelect){
                submissionFormsSelect.addEvent('change', function(){
                    loadSubmissionFormData(submissionFormsSelect.getSelected().map(function(option){
                        return option.value;
                    }));
                });
                submissionFormsSelect.fireEvent('change');
            }
            if(submissionFormSelect){
                submissionFormSelect.addEvent('change', function(){
                    loadSubmissionFormData([submissionFormSelect.value])
                });
                submissionFormSelect.fireEvent('change');
            }

            jQuery('.upload_container').load('{% url 'ecs.notifications.views.upload_document_for_notification' docstash_key=request.docstash.key %}');

            if ($('id_study_started')) {
                new ecs.FormFieldController(['id_reason_for_not_started'], {
                    sources: ['id_study_started'],
                    auto: function(values, initial){
                        this.requireField($('id_reason_for_not_started'), !values[0]);
                        this.setDisabled(values[0]);
                    }
                });
            }
        });
    </script>
{% endblock %}

