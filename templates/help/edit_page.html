{% extends "help/base.html" %}

{% block upload_params %}{% if page.view_id %}&amp;view={{ page.view_id }}{% endif %}&amp;page={{ page.id }}{% endblock %}

{% block content %}
    {{ form.errors }}
    <form action="" method="post" id="helpform">
        <div>
            View: {{ form.view }}
            Anchor: {{ form.anchor }}
            Slug: {{ form.slug }}
        </div>
        <div class="title">{{ form.title }}</div>
        <div class="text">
            <div>
            <a href="" id="ReST_italic"><i>kursiv</i></a> 
            | <a href="" id="ReST_bold"><b>fett</b></a>
            | <a href="" id="ReST_heading">Ãœberschrift</a>
            | <a href="" id="ReST_preview">Vorschau</a>
            </div>
            {{ form.text }}
        </div>
        <input type="submit" value="Speichern" />
    </form>
    <div id="help_attachments">
        <input type="text" id="help_attachments_filter_input"/>
        <div class="list">
            {% for attachment in attachments %}
            <div>
                <img src="{% url ecs.help.views.download_attachment attachment.pk %}" draggable="false"/>
                <span class="slug">{{ attachment.slug }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block jsbottom %}
{{ block.super }}
<script type="text/javascript" src="{{ MEDIA_URL }}js/restructuredtext.js"></script>
<script type="text/javascript">
    window.addEvent('domready', function(){
        var textarea = $('id_text');
        var r = new ReST(textarea);
        $('ReST_italic').addEvent('click', function(){r.makeItalic(); return false;});
        $('ReST_bold').addEvent('click', function(){r.makeBold(); return false;});
        $('ReST_heading').addEvent('click', function(){r.makeHeading(); return false;});
        $('ReST_preview').addEvent('click', function(){
            var preview = $('help_preview');
            if(preview){
                preview.dispose();
                return false;
            }
            
            preview = new Element('div', {id: 'help_preview'});
            var size = textarea.getSize();
            var pos = textarea.getPosition();
            preview.setStyles({left: pos.x, top: pos.y, width: size.x, height: size.y});
            var request = new Request.HTML({
                url: '{% url ecs.help.views.preview_help_page_text %}',
                method: 'post',
                data: 'text=' + encodeURIComponent(textarea.value),
                update: preview,
                onSuccess: function(){
                    document.body.appendChild(preview);
                }
            });
            request.send();
            return false;
        });
        
        var attachments = {
            input: $('help_attachments_filter_input'),
            interval: null,
            query: '',
            refresh: function(){
                if(this.input.value == this.query){
                    return;
                }
                this.query = this.input.value;
                var request = new Request.HTML({
                    update: $$('#help_attachments > .list')[0],
                    url: '{% url ecs.help.views.find_attachments %}?q=' + encodeURIComponent(this.query),
                    onSuccess: function(){
                        $$('#help_attachments > .list > div').each(function(d){
                            new Drag.Move(d, {
                                droppables: '#id_text',
                                onStart: function(element){
                                    this._startPos = element.getPosition();
                                    console.log(this._startPos);
                                },
                                onDrop: function(element){
                                    console.log(arguments);
                                    textarea.focus();
                                    textarea.insertAtCursor('\n.. image:: ' + element.getElement('span.slug').innerHTML);
                                    element.setStyles({'position': 'relative', 'top': '0px', 'left': '0px'});
                                }
                            });
                        });
                    }
                });
                request.send();
            },
            setup: function(){
                var self = this;
                this.input.addEvent('focus', function(){
                    this.interval = setInterval(self.refresh.bind(self), 500);
                });
                this.input.addEvent('blur', function(){
                    clearInterval(self.interval);
                });
                this.input.addEvent('keydown', function(e){
                    if(e.key == 'enter'){
                        self.refresh();
                    }
                });
            }
        };
        
        attachments.setup();
        
    });
</script>
{% endblock %}