{% extends "help/base.html" %}
{% load staticfiles %}

{% block upload_params %}{% if page.view_id %}&amp;view={{ page.view_id }}{% endif %}&amp;page={{ page.id }}{% endblock %}

{% block content %}
    {{ form.errors }}
    <form action="" method="post" id="helpform">
        {% csrf_token %}
        <div class="dir">
            Slug: {{ form.slug }}
            View: {{ form.view }}
            Anchor: {{ form.anchor }}
        </div>
        <div class="title">{{ form.title }}</div>
        <div class="text">
            <div class="options">
            <a id="ReST_italic" class="fa fa-italic" title="Italic"></a>
            | <a id="ReST_bold" class="fa fa-bold" title="Bold"></a>
            | <a id="ReST_heading" class="fa fa-header" title="Header"></a>
            | <a id="ReST_preview">Vorschau</a>
            </div>
            {{ form.text }}
        </div>
        <input type="submit" value="Speichern" />
    </form>
    <div id="help_attachments">
        <label>Filter <input type="text" id="help_attachments_filter_input"/></label>
        <div class="list"></div>
    </div>
{% endblock %}

{% block jsbottom %}
{{ block.super }}
<script type="text/javascript">
    $(function(){
        var textarea = $('#id_text');

        var csrftoken = document.cookie.split('; ')
            .find(function(el) {
                return el.startsWith('csrftoken=');
            })
            .split('=', 2)[1];

        $('#ReST_italic').click(function(ev) {
            ev.preventDefault();
            var text = textarea.val(), t = textarea.get(0);
            var s = t.selectionStart, e = t.selectionEnd;
            text = text.slice(0, s) + '*' + text.slice(s, e) + '*' + text.slice(e);
            textarea.val(text);
            textarea.focus();
            t.setSelectionRange(s + 1, e + 1);
        });
        $('#ReST_bold').click(function(ev) {
            ev.preventDefault();
            var text = textarea.val(), t = textarea.get(0);
            var s = t.selectionStart, e = t.selectionEnd;
            text = text.slice(0, s) + '**' + text.slice(s, e) + '**' + text.slice(e);
            textarea.val(text);
            textarea.focus();
            t.setSelectionRange(s + 2, e + 2);
        });
        $('#ReST_heading').click(function(ev) {
            ev.preventDefault();
            var text = textarea.val(), t = textarea.get(0);
            var s = t.selectionStart, e = t.selectionEnd;
            var header = text.slice(s, e).trim();

            if (!header)
                return;

            text = text.slice(0, s) + '\n\n' + header + '\n' + '~'.repeat(header.length) + '\n' + text.slice(e);
            textarea.val(text);
            textarea.focus();
            t.setSelectionRange(s + 2, s + 2 + header.length);
        });
        $('#ReST_preview').click(function(ev) {
            ev.preventDefault();

            var preview = $('#help_preview');
            if (preview.length) {
                preview.remove();
                return;
            }

            preview = $('<div />', {id: 'help_preview'});
            preview.css(textarea.position());
            preview.css({width: textarea.width(), height: textarea.height()});

            $.ajax({
                url: '{% url 'ecs.help.views.preview_help_page_text' %}',
                method: 'post',
                headers: {'X-CSRFtoken': csrftoken},
                data: {text: textarea.val()},
                success: function(data) {
                    $('body').append(preview);
                    preview.html(data);
                }
            });
        });
        
        var attachments = {
            input: $('#help_attachments_filter_input'),
            refresh: function(force){
                if (!force && this.input.val() == this.query)
                    return;

                this.query = this.input.val();
                var self = this;

                $.ajax({
                    url: '{% url 'ecs.help.views.find_attachments' %}',
                    method: 'get',
                    data: {q: this.query},
                    success: function(data) {
                        var list = $('#help_attachments > .list');
                        list.html(data);
                        list.find('a').click(function(ev) {
                            ev.preventDefault();
                            $.get({
                                url: $(this).attr('href'),
                                success: function() {
                                    self.refresh(true);
                                }
                            });
                        });
                        list.find('img').click(function(ev) {
                            ev.preventDefault();
                            var slug = $(this).parent().data('slug');

                            var text = textarea.val(), t = textarea.get(0);
                            var s = t.selectionStart, e = t.selectionEnd;
                            var ref = '\n.. image:: ' + slug + '\n';
                            text = text.slice(0, s) + ref + text.slice(e);
                            textarea.val(text);
                            textarea.focus();
                            t.setSelectionRange(s + 1, s + ref.length - 1);
                        });
                    }
                });
            },
            setup: function(){
                var self = this;
                this.input.focus(function(ev) {
                    this.interval = setInterval(function() {
                        self.refresh();
                    }, 500);
                });
                this.input.blur(function(ev) {
                    clearInterval(self.interval);
                });
                this.input.keydown(function(ev){
                    if(ev.key == 'Enter')
                        self.refresh();
                });
                this.refresh(true);
            }
        };
        
        attachments.setup();
        
    });
</script>
{% endblock %}
