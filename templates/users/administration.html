{% extends 'administration/detail.html' %}
{% load i18n userutils %}

{% block htmltitle %}{% trans "User Administration" %} | {{ block.super }}{% endblock %}

{% block administration_detail %}
<h2>{% trans "List of Users" %} ({{ users.paginator.count }})</h2>

<form id="{{ form_id }}" action="" method="post">
    {% csrf_token %}
    <ul class="useradministration_choose">
        <li><label for="id_activity">{% trans "Activity" %}:</label> {{ filterform.activity }}</li>
        <li><label for="id_groups">{% trans "Groups" %}:</label> {{ filterform.groups }}</li>
        <li><label for="id_groups">{% trans "Medical Categories" %}:</label> {{ filterform.medical_categories }}</li>
        <li><label for="id_keyword">{% trans "Name/Email" %}:</label> {{ filterform.keyword }}</li>
        <li><input type="submit" value="suchen" title="suchen" /></li>
    </ul>
    {{ filterform.page }}
</form>

<div class="paginator">
    {% if not users.number == 1 %}
        <a href="#" class="first_page">first</a>
    {% endif %}
    {% if users.has_previous %}
        <a href="#" class="prev_page">previous</a>
    {% endif %}
    {% trans "Page" %} {{ users.number }} {% trans "of" %} {{ users.paginator.num_pages }}
    {% if users.has_next %}
        <a href="#" class="next_page">next</a>
    {% endif %}
    {% if not users.number == users.paginator.num_pages %}
        <a href="#" class="last_page">last</a>
    {% endif %}
</div>

<ul class="user_list">
{% for profile in users.object_list %}
    <li class="user collapsed{% if profile|has_flag:"is_indisposed" %} indisposed{% endif %}{% if not profile.is_active %} inactive{% endif %}">
        <div class="head">
            <span class="username">
                {{ profile|formal_name }}
                {% if profile.get_profile.is_phantom %}
                    ({% trans "phantom" %})
                {% endif %}
            </span>
            <span class="email">{{ profile.email }}</span>
            <span class="indisposed_warning">[{% trans 'Indisposed' %}]</span>
            <span class="inactive_warning">[{% trans 'Inactive' %}]</span>
        </div>
        <div class="body">
            <a href="{% url 'ecs.users.views.details' user_pk=profile.pk %}">{% trans 'Edit Details' %}</a>
            | <a href="{% url 'ecs.users.views.indisposition' user_pk=profile.pk %}">
                    {% if profile|has_flag:"is_indisposed" %}{% trans "Unmark Indisposed" %}{% else %}{% trans "Mark Indisposed" %}{% endif %}
                </a>
            | <form action="{% url 'ecs.users.views.toggle_active' user_pk=profile.pk %}" method="post"><a href="" class="submit_parent">{% if profile.is_active %}{% trans "Deactivate" %}{% else %}{% trans "Activate" %}{% endif %}</a>{% csrf_token %}</form>
            {% with profile as profile_user %}
            {% with profile_user.get_profile as profile %}
            <div class="profile">
            <table class="profile_data">
                <tr><th>Organisation:</th><td>{{ profile.organisation }}</td></tr>
                <tr><th>Position:</th><td>{{ profile.jobtitle }}</td></tr>
                <tr><th>E-Mail:</th><td>{{ profile_user.email }}</td></tr>
                <tr><th>Telefon:</th><td>{{ profile.phone }}</td></tr>
                <tr><th>Fax:</th><td>{{ profile.fax }}</td></tr>
                <tr><th>Adresse/Privatadresse falls Gutachter:</th><td>
                    {{ profile.address1 }}<br/>
                    {{ profile.address2 }}<br/>
                    {{ profile.zip_code }} {{ profile.city }}
                </td></tr>
                <tr><th>IBAN:</th><td>{{ profile.iban }}</td></tr>
                <tr><th>SWIFT-BIC:</th><td>{{ profile.swift_bic }}</td></tr>
                <tr><th>Sozialversicherungsnummer:</th><td>{{ profile.social_security_number }}</td></tr>
            </table>
            </div>
            {% endwith %}
            {% endwith %}
        </div>
    </li>
{% endfor %}
</ul>

<div class="paginator">
    {% if not users.number == 1 %}
        <a href="#" class="first_page">first</a>
    {% endif %}
    {% if users.has_previous %}
        <a href="#" class="prev_page">previous</a>
    {% endif %}
    {% trans "Page" %} {{ users.number }} {% trans "of" %} {{ users.paginator.num_pages }}
    {% if users.has_next %}
        <a href="#" class="next_page">next</a>
    {% endif %}
    {% if not users.number == users.paginator.num_pages %}
        <a href="#" class="last_page">last</a>
    {% endif %}
</div>
{% endblock %}

{% block jsbottom %}
    {{ block.super }}
    <script type="text/javascript">
        window.addEvent('domready', function(){
            var form = $('{{ form_id }}');
            var page_input = form.getElement('input[name="page"]');

            ecs.setupAutocomplete(form);
            ecs.setupSubmitLinks('a.submit_parent');

            form.getElements('input').each(function(input){
                input.addEvent('change', function(){
                    page_input.value = 1;
                    $('{{ form_id }}').submit();
                });
            });
            form.getElements('select').each(function(input){
                input.addEvent('change', function(){
                    page_input.value = 1;
                    $('{{ form_id }}').submit();
                });
            });

            $$('.paginator').each(function(paginator){
{% if not users.number == 1 %}
                paginator.getElement('a.first_page').addEvent('click', function(){
                    page_input.value = 1;
                    form.submit();
                });
{% endif %}
{% if users.has_previous %}
                paginator.getElement('a.prev_page').addEvent('click', function(){
                    page_input.value = parseInt(page_input.value, 10) - 1;
                    form.submit();
                });
{% endif %}
{% if users.has_next %}
                paginator.getElement('a.next_page').addEvent('click', function(){
                    page_input.value = parseInt(page_input.value, 10) + 1;
                    form.submit();
                });
{% endif %}
{% if not users.number == users.paginator.num_pages %}
                paginator.getElement('a.last_page').addEvent('click', function(){
                    page_input.value = {{ users.paginator.num_pages }};
                    form.submit();
                });
{% endif %}
            });
            
            var user_list = $$('ul.user_list')[0];
            user_list.getElements('.user').each(function(user){
                user.getElement('.head').addEvent('click', (function(){
                    if (user.hasClass('collapsed')) {
                        user.removeClass('collapsed');
                    } else {
                        user.addClass('collapsed');
                    }
                    return false;
                }).bind(this));
            }, this);
        });
    </script>
{% endblock %}

