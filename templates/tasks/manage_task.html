{% load core i18n userutils %}

<div id="task_main">
<form action="{% url ecs.tasks.views.manage_task task_pk=task.pk %}" method="post" id="task_form" class="open-in-widget">
    <div class="show_all"><a href="{% url ecs.tasks.views.my_tasks %}" class="open-in-widget">{% trans 'Show all tasks' %}</a></div>
    <h2>{{ task }}</h2>
    {% if task.locked %}
    <span class="lockInfo">Dieser Task kann noch nicht abgeschlossen werden.</span>
    {% endif %}
    {% if form.errors|contains:'action' %}
    <span class="errors">
        Bitte w√§hlen Sie eine Aktion aus.
    </span>
    {% endif %}
    <ul>
        {% if not task.choices %}
        <li>
            <input type="radio" name="action" id="id_action_complete" value="complete"{% ifequal form|form_value:'action' 'complete' %} checked="checked"{% endifequal %} {% if task.locked %} disabled="disabled"{% endif %}/>
            <label for="id_action_complete"><span class="task_complete"></span>{% trans 'Close' %}</label>
        </li>
        {% else %}
            {% for val, label in task.choices %}
            <li>
                <input type="radio" name="action" id="id_action_complete_{{ forloop.counter0 }}" value="complete_{{ forloop.counter0 }}" {% if task.locked %} disabled="disabled"{% endif %}/>
                <label for="id_action_complete_{{ forloop.counter0 }}"><span class="task_reject"></span>{{ label }}</label>
            </li>
            {% endfor %}
        {% endif %}
        <li>
            <input type="radio" name="action" id="id_action_delegate" value="delegate"{% ifequal form|form_value:'action' 'delegate' %} checked="checked"{% endifequal %} />
            <label for="id_action_delegate"><span class="task_delegate"></span>{% trans 'Delegate' %}</label>
            <span class="task_delegate_assign">
                <label for="id_assign_to">An</label>{{ form.assign_to }}
                {% if form.assign_to.errors %}
                    <span class="errors">{{ form.assign_to.errors }}</span>
                {% endif %}
            </span>
        </li>
        <li>
            <input type="radio" name="action" id="id_action_message" value="message"{% ifequal form|form_value:'action' 'message' %} checked="checked"{% endifequal %} />
            <label for="id_action_message"><span class="task_ask"></span>{% trans 'Ask' %}</label>
            <span class="task_indent">
            <ol class="task_message">
            {% with message_form as form %}
                {% include 'communication/send_base.inc' %}
            {% endwith %}
            </ol>
            </span>
        </li>
        <li>
          <input type="submit" value="Abschicken" />
        </li>
    </ul>
</form>
</div>

<script type="text/javascript">
    window.addEvent('domready', function(){
        var questionTypeInputs = $$('#id_question_type_callback', '#id_question_type_related', '#id_question_type_somebody');
        questionTypeInputs.each(function(radio){
            radio.addEvent('change', function(){
                $('id_action_message').checked = true;
            });
        });

        var container = $$('.task_message')[0];

        ecs.setupMessagePopup(container, 'message');

        var messageToolbarItems = [];

        {% if task.data.get_submission %}
            messageToolbarItems.push(ecs.textarea.toolbarItems.annotations("{% trans 'Insert Annotations' %}", '{% url ecs.pdfviewer.views.copy_annotations %}?submission_form_pk={{ task.data.get_submission.current_submission_form.pk }}'));
        {% endif %}

        {% if user|has_flag:'internal' %}
            messageToolbarItems.push(ecs.textarea.toolbarItems.boilerplate("{% trans 'Insert Boilerplate' %}", "{% url ecs.boilerplate.views.select_boilerplate %}"));
        {% endif %}

        var textarea = container.getElement('textarea[name="message-text"]');
        console.log(container);
        console.log(textarea);
        new ecs.textarea.TextArea(textarea);
        ecs.textarea.installToolbar(textarea, messageToolbarItems);
        ecs.setupAutocomplete(container);
    });
</script>
